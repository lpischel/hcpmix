---
title: "HCW_Mix_2024_09_12_cleaned"
author: "Lauren Pischel"
date: "9/12/2024"
output: 
  html_document:
    keep_md: yes
    
---

*This document was created by Lauren Pischel on behalf of the Health Care Worker mix group including Obianuju G Agulo, Noureen Ahmed, Kartyhn Willebrand, Ryan Borg, Eliott Painstil, Chelsea Duckwall, Melissa Campbell, Agnieszka Zaleski, Amyn Malik, Ben A Lopman, Samuel M Jenness, Justin Belsky, Joshua Warren, Inci Yildirim, Rick Martinello, Albert I Ko, Saad B Omer*

**Background** The Health care worker (HCW) Mix project enrolled from  October 2020 to June 2022. Initial participants were recruited from an existing cohort called "IMPACT" and then enrollment was expanded to both within all floors of the flag ship hospital (YNHH) and surrounding clinical buildings, as well as the adjacent hospital San Raphael's Hospital (SRC). Only those working at YNHH could participate in the sensor portion of sensor week, while those at SRC and satellite locations could participate in the contact diary. Sensor week took place the first week of June, 2022, during this time participants wore a proximity-sensor for 7 days and completed a 2 day contact diary.  

**Specific aims**

**AIM 1** To characterize the patterns of social contact and mixing across adults Healthcare Workers (HCWs) (age; job category; years of experience) in the Yale New Haven Health (YNHH) systems and their work location (size; policies; sector; season) characteristics using standardized social contact diaries and wearable proximity sensing devices. We will conduct primary social contact data collection among HCWs. We will characterize social mixing rates by age, sex, job title, and other significant predictors of mixing.  


**AIM 2** Determine social, clinical, and biological risk factors for COVID-19 transmission among HCWs in YNHH. We will compare the socio-demographic, economic, medical history, clinical presentation, and biological risk factors from infected versus exposed-and uninfected cohorts. We will follow the cohort for up to 1 year with routine serology testing for COVID-19. 

This document uses data that has been cleaned by the file "HCWMIX_2024_15.Rmd" and can be used to re-create the contact diary analysis.


This document requires 4  files to run: *demographic_June_22_clean.csv* that has information about participant demographics of all those who enrolled in the study,*months_short_clean.csv* which has summative contact information from Jan 2021 to June 2022, *contact_June_22_clean.csv* which has information on individual level contacts from the June 2020 contact diary. *contact_june_22_long_clean.csv* takes a subset of the data from *contact_June_22_clean.csv*  cleans the data and transforms the individual level contacts into long from. 

Please note first run of this code may take 5-10 minutes


```{r setup, include=FALSE}
knitr::opts_chunk$set(#dev = "tiff",
                      #dpi = 300, #increase dpi
                      #out.width="504px", #control width so dpi increases
                      echo = FALSE, #don't print the the code
                      cache = TRUE)  # save prior knits so it doesn't take forever, might have to change with big updates  

library(tidyverse)
library(plyr)
library(ggplot2)
library(GGally)
library(lubridate)
library(readxl)
library(stringr)
library(skimr)#https://www.business-science.io/code-tools/2023/01/05/exploratory-dataxray-analysis.html?utm_content=buffer39c75&utm_medium=social&utm_source=twitter.com&utm_campaign=buffer
library(data.table)
library(ggmosaic)
library(tableone)
library(sjPlot)
library(moments)
library(socialmixr)
library(writexl)
library(dplyr)
library(forcats)
library(gtsummary)
library(DataExplorer)
library(broom)
library(flextable)
library(MASS)
require(flexplot)
library(ggpubr)
library(naniar)
library(gridExtra)
library(cowplot)
library(grid)
library(gtable)
library(scales)
library(ggbreak)
library(corrplot)
library(alluvial)
 library(longCatEDA)
library(easystats)
library(tsModel)
library(janitor)
library(gmodels)
library(FSA)
library(foreign)
library(lme4)
library(ordinal)
library(performance)
library(jtools)
library(splines)


#palette help: http://rstudio-pubs-static.s3.amazonaws.com/5312_98fc1aba2d5740dd849a5ab797cc2c8d.html
#color brewer https://colorbrewer2.org/#type=sequential&scheme=RdPu&n=6

# This document combines different data sets for the Health Care Worker Mix project and provides preliminary data analysis of the contact patterns. Removal of PHI has been documented in code chunks that are commented out. 

# Warning-- the first time you knit this document it will take several minutes to complete the knit

```


# Demographics study


```{r demographic_cleaning}
#read in CSV
demographic_June_22 <- read.csv("demographic_June_22_clean.csv")
# cleaning: make dates and factor variables

#make variable for 1st paper analysis
demographic_June_22$partipation_clean <- factor(demographic_June_22$partipation_clean,
                                        ordered=TRUE, 
                                        levels = c("Enrollment only",
                                                   "Longitudinal diaries", 
                                                   "Sensor week diary",
                                                   "Sensor",
                                                   "Longitudinal diaries & sensor week diary",
                                                   "Longitudinal diaries & sensor",
                                                   "Sensor week diary & sensor",
                                                   "All activities"))


demographic_June_22$partipation_2diary_long <- factor(demographic_June_22$partipation_2diary_long,
                                        ordered=TRUE, 
                                        levels = c("Enrollment only",
                                                   "Longitudinal diaries", 
                                                   "Sensor week diary",
                                                   "All activities"))


demographic_June_22$Ed_factor <- factor(demographic_June_22$Ed_factor, 
                                        ordered=TRUE, 
                                        levels = c("High school graduate or GED",
                                                   "Technical license", 
                                                   "Some college but no degree",
                                                   "Associate's degree",
                                                   "Bachelor's degree",
                                                   "Master's degree",
                                                   "Doctoral degree"))

demographic_June_22$Annual_income_factor <- factor(demographic_June_22$Annual_income, 
                                                   ordered=TRUE, 
                                                   levels = c("Less than $20,000    ",
                                                              "$20,000 to $34,999   ",
                                                              "$35,000 to $49,999    ", 
                                                              "$50,000 to $74,999    ", 
                                                              "$75,000 to $99,999   ", 
                                                              "More than $100,000   "))
demographic_June_22$hours_hospital_sum <- factor(demographic_June_22$hours_hospital_sum, 
                                        ordered=TRUE, 
                                        levels = c("0-20 hours per week",
                                                   "21-40 hours per week", 
                                                   "41-60 hours per week",
                                                   "60 hours per week or more"))


# Create cleaned job df for later join 
job_df <- demographic_June_22 %>% dplyr::select(c(HCWID, Job_sum, Department_sum))
job_df <- job_df %>% distinct(HCWID, .keep_all=TRUE)

# Create Dept summary data frame for later join
dept_df <- demographic_June_22 %>% dplyr::select(c(HCWID, Department_overall_sum))

# Create age dataframe
age_df <- demographic_June_22 %>% dplyr::select(c(HCWID, age))
age_df <- age_df %>% distinct(HCWID, .keep_all=TRUE)  # remove duplicate HCW IDs

#Gender DF
sex_df <- demographic_June_22 %>% dplyr::select(c(HCWID, Gender))
sex_df <- sex_df %>% distinct(HCWID, .keep_all=TRUE) # 360 unique 

#make dates
demographic_June_22 <- demographic_June_22 %>%
  mutate(StartDate =mdy(StartDate))%>%
   mutate(EndDate =mdy(EndDate))%>%
    mutate(RecordedDate =mdy_hm(RecordedDate))

```

For job, some groups were combined for simplicity such as resident doctors and attending doctors. Also groups that might move around the hospital quite a bit (physical therapy, occupational therapy, speech therapy, transport) were also grouped together.

Department and Job "overall sum" created to create fewer groups for regression analysis, so for example administrative positions with less patient contact were combined (Social worker and Administrative staff) as were nurses and nursing assistants

Department is a bit tricky, for example a pharmacists who works in the ED I listed as pharmacy (as that is technically where they were hired), but they are effectively working the ED. Similarly Pediatric infectious disease is just listed as pediatrics. Digestive diseases was put in internal medicine (only 1 participant). Can decrease N of departments if add all IM departments together (ID, pulm, +/- heme/onc). Those that had only 1 in a department I just added to "other". Digestive diseases, Infectious disease, and pulmonary/critial care was added to Internal Medicine since it is technically in that department. 

Other for race also includes "prefer not to say"


`
```{r, Table1, echo=FALSE}
#Generate table 1

demographic_June_22 %>% 
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn,partipation_clean) %>%
  tbl_summary(by ="partipation_clean",
    label = list(
      age ~"Age",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
      Department_overall_sum ~ "Department",
      n_household ~ "N household members",
      n_household_gr18 ~ "N household members over the age of 18",
      hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
    add_overall() %>%
  modify_spanning_header(c("stat_1":"stat_8") ~ "**Participation area**") %>%
  modify_caption("Table Participation Area Demographics")

# can make Household composition into another long data frame if needed 

 #write.csv(demographic_June_22$HCWID, "HCWID_diary_week.csv", row.names=FALSE)

t1 <- demographic_June_22 %>% 
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn,partipation_2diary_long) %>%
  tbl_summary(by ="partipation_2diary_long",
    label = list(
      age ~"Age",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
       Department_overall_sum ~ "Department",
      n_household ~ "N household members",
       n_household_gr18 ~ "N household members over the age of 18",
       hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
    add_overall() %>%
  modify_spanning_header(c("stat_1":"stat_4") ~ "**Participation area**") %>%
   modify_caption("Table 1: Demographics Sensor Week diary and longitudinal diary participation")


```


```{r T_Household_compostion_and_medical}
# Table Household Composition

demographic_June_22 %>% 
   mutate(Household = case_when(Household == "Spouse/significant other only" ~ "Spouse/significant other",
                                Household == "Spouse/significant other only,Children" ~ "Spouse/significant other & children",
                                Household == "Spouse/significant other only,Children,Other, please specify:" ~ "Spouse/significant other & children & other",
                                Household == "Spouse/significant other only,Children,Other (Please specify)" ~ "Spouse/significant other & children & other",
                                Household == "Spouse/significant other only,Parents,Children" ~ "Spouse/significant other & children & parents",
                                Household == "Children,Other, please specify:" ~ "Children & other person",
                                Household == "Children,Other (Please specify)" ~ "Children & other person",
                                Household == "Other, please specify:" ~ "Other person",
                                Household == "Parents,Children" ~ "Parents & children",
                                Household == "Parents,Siblings" ~ "Parents & siblings",
                                Household == "Room mates" ~ "Roommates",
                                Household == "Other (Please specify)" ~ "Other person",
                                 Household == "Parents,Other (Please specify)" ~ "Parents & other person",
                                Household == "Spouse/significant other only,Other, please specify:" ~ "Spouse/significant other & other person",
                                Household == "Spouse/significant other only,Parents,Siblings,Other (Please specify)" ~ "Spouse/significant other & parents & other person",
                                Household == "Spouse/significant other only,Room mates" ~ "Spouse/significant other & roomates",
                                Household == "Spouse/significant other only,Roommates,Other, please specify:" ~ "Spouse/significant other & roomates & other",
                                Household == "Spouse/significant other only,Siblings" ~ "Spouse/significant other & siblings",
    TRUE ~ Household))%>%
  dplyr::select(Household) %>%
  tbl_summary(label = list(Household ~ "Household composition"),
    sort = all_categorical() ~ "frequency") %>%
   modify_caption("Table 2a. Household composition") 
  


demographic_June_22 %>% 
   mutate(Household = case_when(Household == "Spouse/significant other only" ~ "Spouse/significant other",
                                Household == "Spouse/significant other only,Children" ~ "Spouse/significant other & children",
                                Household == "Spouse/significant other only,Children,Other, please specify:" ~ "Spouse/significant other & children & other",
                                Household == "Spouse/significant other only,Children,Other (Please specify)" ~ "Spouse/significant other & children & other",
                                Household == "Spouse/significant other only,Parents,Children" ~ "Spouse/significant other & children & parents",
                                Household == "Children,Other, please specify:" ~ "Children & other",
                                Household == "Other, please specify:" ~ "Other person",
                                Household == "Parents,Children" ~ "Parents & children",
                                Household == "Parents,Siblings" ~ "Parents & siblings",
                                Household == "Room mates" ~ "Roommates",
                                Household == "Other (Please specify)" ~ "Other person",
                                Household == "Children,Other (Please specify)" ~ "Children & other",
                                 Household == "Children,Other (Please specify)" ~ "Children & other",
                                 Household == "Parents,Other (Please specify)" ~ "Other composition",
                                Household == "Spouse/significant other only,Other, please specify:" ~ "Other composition",
                                Household == "Spouse/significant other only,Parents,Siblings,Other (Please specify)" ~ "Other composition",
                                Household == "Spouse/significant other only,Room mates" ~ "Other composition",
                                Household == "Spouse/significant other only,Roommates,Other, please specify:" ~ "Other composition",
                                Household == "Spouse/significant other only,Siblings" ~ "Other composition",
    TRUE ~ Household))%>%
  dplyr::select(Household) %>%
  tbl_summary(label = list(Household ~ "Household composition"),
    sort = all_categorical() ~ "frequency") %>%
   modify_caption("Table 2b. Household composition summarized") 
  


#Table 3 Medical conditions
demographic_June_22 %>% 
   mutate(medical_contions = case_when(str_detect(medical_contions, pattern = "Other") ~ "Other",
    str_detect(medical_contions, pattern = "Hypertension") ~ "Hypertension",
    str_detect(medical_contions, pattern = "Chronic Respiratory Disease (Lung disease e.g. COPD)") ~ "Asthma or lung disease",
    TRUE ~ medical_contions))%>% 
  mutate(medical_contions = na_if(medical_contions,""))%>%
  separate_rows(medical_contions, sep=",") %>% #separate medical condition question based on comma, 
  dplyr::select(medical_contions) %>% #make table
  tbl_summary(
    label = list(medical_contions ~ "Medical conditions"),
    sort = all_categorical() ~ "frequency",
    missing ="no") %>% #remove NA row)%>% ) %>%
   modify_caption("Table 3. Medical conditions"
                  )




```


```{r summary_demo}
library(summarytools)

demographic_June_22 %>%
  select(-X)%>%
  dfSummary(
    graph.col = TRUE,
    style = "grid",
    graph.magnif = 0.75
  ) %>%
  stview()

```

**Note** table of medical conditions, people hand multiple medical conditions, these were counted by  so will sum to more than the total N

**Note:** The other medical conditions are Rheumatoid arthritis, Thyroid nodules,  Ulcerative colitis, PCOS, Hyperlipdemia, Prolactinoma, Benign thyroid nodule, thyroid disease,  hypothyroidism, Hidradenitis suppurativa, Idiopathic hypersomnia, sleep apnea, depression, anxiety, Endometriosis, migraines if those want to be broken down further. Further questions on telecommuntting also have a lot of missingness so not included.

## Longtidinal monthly contact

```{r months_longitudinal_clean, echo=FALSE}
#read in Longtidudinal monthly contact CSV
months_short <- read.csv("months_short_clean.csv")


# cleaning: make dates and factor variables

months_short <- months_short %>%
  mutate(RecordedDate= ymd(RecordedDate))

months_short$building_factor <- factor(months_short$building_clean, ordered=FALSE, 
                                          levels = c( "Hospital 1",
                                                      "ED",
                                                      "Tower 1", 
                                                      "Tower 2",
                                                      "Tower 3",
                                                      "Tower 4",
                                                      "Lab",
                                                      "Hopsital 2",
                                                      "Adjacent clinic",
                                                      "Off site",
                                                      "Multi"))

months_short$Q5_f <- factor(months_short$Q5, ordered=TRUE, 
                                          levels = c( "Monday",
                                                      "Tuesday",
                                                      "Wednesday", 
                                                      "Thursday",
                                                      "Friday",
                                                      "Saturday",
                                                      "Sunday"))    

months_short$Q7_f <- factor(months_short$Q7, ordered=TRUE, 
                                          levels = c( "Few hours",
                                                      "1 day",
                                                      "2 to 7 days",
                                                      "1 to 2 weeks", 
                                                      "More than 2 weeks",
                                                      "None of these"))

months_short$Q19 <- factor(months_short$Q19, ordered=TRUE, 
                                          levels = c( "Less than 5",
                                                      "5 to 9",
                                                      "10 to 19",
                                                      "20 to 29",
                                                      "30 to 39",
                                                      "40 to 49",
                                                      "More than 50"
                                ))      



months_short$Q20 <- factor(months_short$Q20, ordered=TRUE, 
                                          levels = c( "Less than 5",
                                                      "5 to 10",
                                                      "11 to 20",
                                                      "More than 20"
                                ))        


months_short$Q21<- factor(months_short$Q21, ordered=TRUE, 
                                          levels = c( "Less than 5",
                                                      "6 to 10",
                                                      "11 to 15",
                                                      "16 to 20",
                                                      "21 to 25",
                                                      "26 to 30",
                                                      "More than 30"
                                ))     

months_short$Q22<- factor(months_short$Q22, ordered=TRUE, 
                                          levels = c( "Less than 5",
                                                      "6 to 10",
                                                      "11 to 15",
                                                      "16 to 20",
                                                      "21 to 25",
                                                      "26 to 30",
                                                      "More than 30"
                                ))     


#make follow_up into days unit

```


Average follow up time **`r months_short%>% group_by(HCWID)%>% filter(followup_up == max(followup_up, na.rm=TRUE))%>% summarise(median = median(followup_up), na.rm=TRUE)`** median follow up time, IQR ( **`r months_short%>%   group_by(HCWID)%>%   filter(followup_up == max(followup_up, na.rm=TRUE))%>%  summarize(quant25 = quantile(followup_up, probs = .25), na.rm=TRUE) `**  to **`r months_short%>%   group_by(HCWID)%>%   filter(followup_up == max(followup_up, na.rm=TRUE))%>%  summarize(quant25 = quantile(followup_up, probs = .75), na.rm=TRUE) `** )

```{r month_contact table, echo=FALSE}
#create table of longitudinal  contact diaries

months_short %>%
  dplyr::select(Finished,building_factor, building_sum,in_out,Q5_f,sx_yn,Q7_f,Q8,Q9, Q10, Q11, Q16, Q19:Q22,Q29,Q30,Q31,mo_yr)%>%
  filter(mo_yr != c("2020-11"))%>% #remove 1st month as study starting
  filter(mo_yr != c("2022-07"))%>%  #remove last month when study closed starting
  filter(mo_yr != c("2021-06"))%>% #remove months when study closed
  filter(mo_yr != c("2021-07"))%>% #remove months when study closed
  tbl_summary(by =  mo_yr,
    label = list( building_factor ~"Building",
    building_sum ~"Hospital",
    in_out ~ "In vs. out",
    Q5_f~"Day of week",
    sx_yn~"COVID symptoms in past month (Yes)",
    Q7_f~"Duration of symptoms",
    Q8 ~"Work with symptoms (Yes)",
    Q9 ~"Household members with COVID symptoms",
    Q10 ~"N shifts on COVID unit",
    Q11 ~"Participated in COVID Code Blue",
    Q16 ~"Within 6 feet of COVID intubation",
    Q19 ~"Average N patients direct contact",
    Q20 ~"Average minutes spent with a patient",
    Q21 ~"Average N patients indirect contact",
    Q22 ~"Average N HCWs direct contact",
    Q29 ~ "N hours worked on reported day",
    Q30 ~"Large groups (Y/N)",
    Q31 ~"N contacts reported"
  ),
  type = Q10 ~"categorical")%>%
  add_overall() %>%
  modify_caption("Supplemental Table 1. Longitudional summative contacts Jan 2021-June 2022" )


# months_short %>%
#   filter(mo_yr != c("2020-11"))%>% #remove 1st month as study starting
#   filter(mo_yr != c("2022-07"))%>%  #remove last month when study closed starting n= 1
#   filter(mo_yr != c("2021-06"))%>% #remove months when study closed n= 3
#   filter(mo_yr != c("2021-07"))%>% #remove months when study closed n = 1
#   nrow() #469


#problem with mo_yr loosing data

months_short %>%
  ggplot(aes(Q31))+
  geom_histogram(bins = 15)+ 
  ggtitle("Summative total contacts- all longitudinal diaires (Jan '21-June '22)")+
  xlab("Total N contacts per past 24 hrs of work ")

```

There were **`r nrow(months_short)`** reports initiated across **`r length(unique(months_short$HCWID))`** HCWs from Jan 2021 to July 2022. Of these **`r months_short %>% dplyr::select(Q4, mo_yr)%>% filter(is.na(mo_yr))%>% nrow()`** had 8% completion or less and did not provide a reporting date (one of the first questions in the survey) and these were excluded. **4** were completed during Nov 2020, June 2021, July 2021, July 2022 and were excluded.

The **r` months_short %>%  filter(mo_yr != c("2020-11"))%>%  filter(mo_yr != c("2022-07"))%>%    filter(mo_yr != c("2021-06"))%>% filter(mo_yr != c("2021-07"))%>% nrow()`**  diaries had **`r months_short %>%  filter(mo_yr != c("2020-11"))%>%  filter(mo_yr != c("2022-07"))%>%    filter(mo_yr != c("2021-06"))%>%   filter(mo_yr != c("2021-07"))%>%  distinct(HCWID)%>%  nrow()`** unique HCWs completing them.

Those with NAs are presented as "unknown". In the intensive contact diary in May-June 2022, the question about COVID-19 units was removed to reflect the changing COVID response structure of the hospital.
Fix NAs of 


**`r months_short %>%  filter(Finished=="FALSE")%>% nrow()`** surveys were incomplete, all stopping when reporting contact details. Of these **`r months_short %>% filter(is.na(Q31))%>% nrow()`** did not provide any  contact information, the remaining **`r months_short %>%  filter(Finished=="FALSE")%>% nrow() - months_short %>% filter(is.na(Q31))%>% nrow()`** provided some but not all contact information. Additionally, **`r months_short %>%  filter(Q31=="0")%>% nrow()`** of the remaining diaries did not report any detailed contact info ("0") so there is likely a lot of under reporting. 

In Jan 2021, many of these people were more so from the IMPACT cohort, some of whom had long COVID or were not working at the time. In total **`r months_short %>%filter(Finished=="TRUE")%>% nrow()-months_short %>%  filter(Q31=="0")%>% nrow()`** entries with detailed contacts were provided from Jan 2021 to June 2022.

Notes to self: Average N patients with Left skewed, pretty good distribution of time spent with patients
Contacts fairly stable over time

Sub floor was taken out of the table since there are so many it makes the table unreadable **`r months_short %>% distinct(sub_floor)%>%nrow()`** different sub floors!

After April and May  2021 started doing shorter abridged contact diary without detailed contact info. Study was placed on hold June and July 2021 

```{r summary_demo}


months_short %>%
  dplyr::select(-c(X,ResponseId, Q2, Q2_6_TEXT))%>%
  dfSummary(
    graph.col = TRUE,
    style = "grid",
    graph.magnif = 0.75
  ) %>%
  stview()


```


## Time series analysis 

```{r echo=FALSE}
# make time series analysis for N contacts

df_mean_std<- months_short %>%
  dplyr::select(mo_yr,Q31,Q29)%>% #select desired columns
  na.omit()%>% 
  group_by(mo_yr) %>%
  dplyr::summarise(mean = mean(Q31, na.rm = TRUE),
            sd = sd(Q31, na.rm = TRUE),
            n.contact = n(),
            mean_time = mean(Q29, na.rm = TRUE)) %>%
  mutate(se.contact = sd / sqrt(n.contact),
         lower.ci.contact = mean - qt(1 - (0.05 / 2), n.contact - 1) * se.contact,
         upper.ci.contact = mean + qt(1 - (0.05 / 2), n.contact - 1) * se.contact)

df_mean_std$mo_yr<-ym(df_mean_std$mo_yr)

#https://stackoverflow.com/questions/35953394/calculating-length-of-95-ci-using-dplyr
```

Results of summative contacts of health care workers are shown form January 2021 to June 2022. Contacts were reported over a representative working day (24-hour period) as chosen by the HCW. As the study was closed June and July 2021 these months are excluded. Health care workers provided summative information about number and type of contacts over time. 

Figure 1A: 
Number contacts per day over time shown in violin and box plots. Negative binomial regression shown in blue line with 95% CI in grey. 

```{r Fig_1a_neg_binomial, dpi=1000, echo=FALSE}

Fig1a <- months_short %>%
  dplyr::select(HCWID,mo_yr,Q31,Q29)%>%#select desired columns, n contacts and time at work 
    filter(mo_yr != c("2020-11-01"))%>%
   filter(mo_yr != c("2022-07-01"))%>% #remove 1st and last month since only 2 respondents
   filter(mo_yr != c("2021-06-01"))%>% #remove months when study closed
     filter(mo_yr != c("2021-07-01")) #remove months when study closed#remove when study months were closed

Fig1a$mo_yr<-ym(Fig1a$mo_yr) #convert to date


#Figure 1A violin+bar with regression line: contacts over time
Fig1a %>%
  filter(mo_yr != c("2020-11-01"))%>%
   filter(mo_yr != c("2022-07-01"))%>% #remove 1st and last month since only 2 respondents
   filter(mo_yr != c("2021-06-01"))%>% #remove months when study closed
     filter(mo_yr != c("2021-07-01"))%>% #remove months when study closed
  ggplot(aes(x = mo_yr, y = Q31)) +
  geom_violin(aes(x = mo_yr, y = Q31, fill= factor(mo_yr)))+
  geom_boxplot(aes(x = mo_yr, y = Q31, fill = factor(mo_yr)), width=10)+
  geom_smooth(aes(x = mo_yr, y = Q31),method = "glm.nb")+
  xlab("Time") + 
  ylab("Total contacts")+
  scale_x_break(c(ymd("2021-05-01"), ymd("2021-08-01"))) +
  scale_x_date(date_breaks = "2 months", date_labels = "%m-%Y")+
  ggtitle("A")+
  theme_classic()+
  theme(axis.text.x.top = element_blank(), axis.ticks.x.top = element_blank(), legend.position = "none")


#https://www.bayesrulesbook.com/chapter-12
```


Times series decomposition of total number of contacts over time 
```{r lm_contact_time,  echo=FALSE}

# df_mean_std <- months_short %>%
#   group_by(mo_yr)%>%
#  summarise_at(vars(Q31), list(mean=mean, sd=sd),na.rm=TRUE) %>% 
#   as.data.frame()


# count<- months_short %>%
#   group_by(mo_yr)%>%
#   tally()
# 
# count <-count$n #create row of count and bind
# 
# df_mean_std <- cbind(df_mean_std,count)

#why did we loose the months after may 2021?

#plot mean and standard deviation of points by team

fit1 <- lm(mean ~mo_yr, data =df_mean_std)
summary(fit1)$coefficients[,c("Estimate","Pr(>|t|)")]

#time scale decomponsition
mean_c <- tsdecomp(df_mean_std$mean, c(1,2,5,20))
plot( df_mean_std$mo_yr, df_mean_std$mean)
abline(lm(df_mean_std$mean ~ df_mean_std$mo_yr))

par(mfrow=c(3,1), mar=c(3,4,2,2)+0.1)
#x <- seq(as.Date("1987-01-01"), as.Date("2000-12-31"),"day")
plot(df_mean_std$mo_yr, mean_c[,1], type="l", ylab="Trend", main="(a)") 
plot(df_mean_std$mo_yr, mean_c[,2], type="l", ylab="Seasonal", main="(b)")
plot(df_mean_std$mo_yr, mean_c[,3], type="l", ylab="Residual", main="(c)")

mean_df <- as.data.frame(mean_c)
names(mean_df) <- c("Trend","Season","ShortTerm")


fit2 <- lm(df_mean_std$mean ~ Trend + Season + ShortTerm,
           data=mean_df)
summary(fit2)$coefficients[,c("Estimate", "Pr(>|t|)")] # why is this fit perfect?

# incorporate time worked
fit3 <- lm(mean ~mo_yr + mean_time, data =df_mean_std)
summary(fit3)$coefficients[,c("Estimate","Pr(>|t|)")] 

#created predicated data
predicted_df <- data.frame(cont_pred = predict(fit3, df_mean_std), mean_time=df_mean_std$mean_time)

```


**n.b.** Nov 2020 response was excluded since only 1 person responded(2 entries) and June 2022 excluded since that was for the 2-day contact diaries

June and July 2021 also excluded since the study was closed for that time (break above)


Figure 1B:
Average number of direct contacts a HCW had with patients per day as a percent stacked barplot where month is shown on the x axis and percentage of responses on the y axis
```{r bar_plots_ptn_contact_dir,  echo=FALSE, dpi=1000}
# Make figure 1B: Direct patient contact
months_short %>%
  filter(Q19 != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
   dplyr::count(mo_yr, Q19)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Q19, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2, position = position_fill(vjust=0.4,reverse = TRUE),colour="white")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("B")+
  labs(fill ="Average contacts")

#if want to add labels # https://rpubs.com/techanswers88/stackedbarcharts
#https://stackoverflow.com/questions/35097489/put-total-observation-number-n-on-top-of-stacked-percentage-barplot-in-ggplot
# https://stackoverflow.com/questions/22231124/how-to-draw-stacked-bars-in-ggplot2-that-show-percentages-based-on-group

```


Figure 1C:
Average number of indirect contacts a HCW had with patients per day. 
```{r bar_plots_ptn_contact_indirect,  dpi=1000, echo=FALSE}

#percentage stacked
#create Fig 1c

months_short %>%
  filter(Q21 != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, Q21)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Q21, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2, position = position_fill(vjust=0.4,reverse = TRUE),colour="white")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("C")+
  labs(fill ="Average contacts")


```

Figure 1D:
Did the HCW attend a large group gathering where individuals could not be individually identified during  the reported day (yes/no)

```{r bar_plots_large_group, dpi=1000, echo=FALSE}
#percentage stacked,
#create figure 1D
months_short %>%
  filter(Q30 != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, Q30)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Q30, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2.5, position = position_fill(vjust=0.4,reverse = TRUE),colour="black")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("D")+
  labs(fill ="Large groups")


```
   
```{r bar_plots_hrs_worked_time,  echo=FALSE}

# make time series analysis for N contacts
df_mean_std<- months_short %>%
  dplyr::select(mo_yr,Q29)%>% #select desired columns
  na.omit()%>% 
  group_by(mo_yr) %>%
  dplyr::summarise(mean = mean(Q29, na.rm = TRUE),
            sd = sd(Q29, na.rm = TRUE),
            n.contact = n()) %>%
  mutate(se.contact = sd / sqrt(n.contact),
         lower.ci.contact = mean - qt(1 - (0.05 / 2), n.contact - 1) * se.contact,
         upper.ci.contact = mean + qt(1 - (0.05 / 2), n.contact - 1) * se.contact)


df_mean_std$mo_yr<-ym(df_mean_std$mo_yr)


#Lm fits 
fit1 <- lm(mean ~mo_yr, data =df_mean_std)
summary(fit1)$coefficients[,c("Estimate","Pr(>|t|)")]

# #time scale decomponsition
# mean_c <- tsdecomp(df_mean_std$mean, c(1,2,5,20))
# plot( df_mean_std$mo_yr, df_mean_std$mean)
# abline(lm(df_mean_std$mean ~ df_mean_std$mo_yr))
# 
# par(mfrow=c(3,1), mar=c(3,4,2,2)+0.1)
# #x <- seq(as.Date("1987-01-01"), as.Date("2000-12-31"),"day")
# plot(df_mean_std$mo_yr, mean_c[,1], type="l", ylab="Trend", main="(a)") 
# plot(df_mean_std$mo_yr, mean_c[,2], type="l", ylab="Seasonal", main="(b)")
# plot(df_mean_std$mo_yr, mean_c[,3], type="l", ylab="Residual", main="(c)")
# 
# mean_df <- as.data.frame(mean_c)
# names(mean_df) <- c("Trend","Season","ShortTerm")
# fit2 <- lm(df_mean_std$mean ~ Trend + Season + ShortTerm,
#            data=mean_df)
# summary(fit2)$coefficients[,c("Estimate", "Pr(>|t|)")] # why is this fit perfect?
# 
# 
# df_mean_std %>%
#   filter(mo_yr != c("2020-11-01"))%>%
#    filter(mo_yr != c("2022-07-01"))%>% #remove 1st and last month since only 2 respondents
#    filter(mo_yr != c("2021-06-01"))%>% #remove months when study closed
#      filter(mo_yr != c("2021-07-01"))%>% #remove months when study closed
#   ggplot( aes(x = mo_yr)) + 
#   geom_line(aes(y = mean),color = "#6E9BF8", size = 0.75) + 
#   geom_ribbon(aes(y = mean, ymin =lower.ci.contact , ymax = upper.ci.contact, alpha=0)) +
#     geom_abline(slope = coef(fit1)[["mo_yr"]],
#               intercept = coef(fit1)[["(Intercept)"]],linetype=3)+
#   xlab("Time") + 
#   ylab("Mean hrs worked (95% CI)")+
#   scale_x_break(c(ymd("2021-05-01"), ymd("2021-08-01"))) +
#   scale_x_date(date_breaks = "2 months", date_labels = "%m-%Y")+
#   ggtitle("E")+
#   theme_classic()+
#   theme(axis.text.x.top = element_blank(), axis.ticks.x.top = element_blank(), legend.position = "none")


#https://stackoverflow.com/questions/61909908/adding-a-shaded-standard-deviation-to-line-plots-on-ggplot2-for-multiple-variable

#https://cran.r-project.org/web/packages/funtimes/vignettes/trendtests.html

#https://stackoverflow.com/questions/15633714/adding-a-regression-line-on-a-ggplot


```

Fig 1E: Job of HCW on reported contact diary over time
```{r Fig_1E_job_time, dpi=1000, echo=FALSE}


#percentage stacked
Fig1E <- months_short %>%
    dplyr::select(c("HCWID","mo_yr"))

Fig1E <- left_join(Fig1E, job_df, by = "HCWID")

Fig1E%>%
  filter(Job_sum != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, Job_sum)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Job_sum, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2.5, position = position_fill(vjust=0.4,reverse = TRUE),colour="black")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("E")+
  labs(fill ="Job")


```

Fig 1F:: Average contact time HCWs spent with an average patient per day over
```{r bar_plots_ptn_contact_time, dpi=1000, echo=FALSE}

#Create Fig 1F

months_short %>%
  filter(Q20 != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, Q20)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Q20, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2, position = position_fill(vjust=0.4,reverse = TRUE),colour="white")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("F")+
  labs(fill ="Average contacts")

```
**`r months_short %>% filter( Q20 == "More than 20")%>%  nrow() `** individual reports of direct contact with more than 20 patients on average, this was reported from **`r months_short %>% filter( Q20 == "More than 20")%>% distinct(HCWID)%>%  nrow() `** individual health care workers

Fig 1G:
Average number of direct contacts a HCW had with other HCWs per day.

```{r bar_plots_HCW_contact_direct,  dpi=1000, echo=FALSE}
# Create Fig 1G

#percentage stacked
months_short %>%
  filter(Q22 != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, Q22)%>%
  ggplot(aes(x = mo_yr, y=n,fill=Q22, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2, position = position_fill(vjust=0.4,reverse = TRUE),colour="white")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("G")+
  labs(fill ="Average contacts")

```

Figiure 1H:
Building worked by HCW on the reported day in over time.
```{r bar_plots_building_sum, dpi=1000, echo=FALSE}

# create fig 1H

#percentage stacked
months_short %>%
  filter(building_clean != "NA")%>%
  filter(mo_yr != "2020-11")%>% #remove the times when the study was closed 
   filter(mo_yr != "2021-06")%>%
   filter(mo_yr != "2021-07")%>%
   filter(mo_yr != "2022-07")%>%
       dplyr::count(mo_yr, building_clean)%>%
  ggplot(aes(x = mo_yr, y=n,fill=building_clean, label = n)) +
  geom_bar(position = position_fill(reverse = TRUE),stat='identity')+
  #geom_text(size = 2, position = position_fill(vjust=0.4,reverse = TRUE),colour="white")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45,vjust = 1, hjust=1)) +
  guides(fill = guide_legend(reverse=TRUE))+
  xlab("Time") + 
  ylab("Percentage")+
  ggtitle("H")+
  labs(fill ="Building")


```  


## Individual Level contact diaries June 2022

```{r contact_June_22_clean, echo=FALSE}
#read in contact_June_22
contact_June_22 <-read.csv("contact_June_22_clean.csv")


#make dates
contact_June_22 <- contact_June_22 %>%
  mutate(StartDate = mdy_hm(StartDate))%>%
   mutate(EndDate = mdy_hm(EndDate))%>%
     mutate(Q2_1 = ymd(Q2_1))%>%
     mutate(Q2_2 = ymd(Q2_2))
  

#Create factor variables and re-level

contact_June_22$Q8 <- factor(contact_June_22$Q8, ordered=TRUE, levels = c("Few hours", 
                                                                          "1 day", 
                                                                          "1 to 2 weeks", 
                                                                          "2 to 7 days",
                                                                          "More than 2 weeks",
                                                                          "None of these")) #factor and reorder


contact_June_22$Q21_factor <- factor(contact_June_22$Q21, ordered=TRUE, levels = c("Less than 5 patients", 
                                                                                   "5-9 patients", 
                                                                                   "10-19 patients", 
                                                                                   "20-29 patients",
                                                                                   "30-39 patients",
                                                                                   "More than 40 patients"))

contact_June_22$Q22_factor <- factor(contact_June_22$Q22, ordered=TRUE, levels = c("Less than 5 minutes", 
                                                                                   "5-10 minutes",
                                                                                   "11-20 minutes", 
                                                                                   "More than 20 minutes"))

contact_June_22$Q23_factor <- factor(contact_June_22$Q23, ordered=TRUE, levels = c("Less than 5 patients", 
                                                                                   "6-10 patients", 
                                                                                   "11-15 patients", 
                                                                                   "16-20 patients", 
                                                                                   "More than 20 patients"))

contact_June_22$Q24_factor <- factor(contact_June_22$Q24, ordered=TRUE, levels = c("Less than 5 HCWs", 
                                                                                   "6-10 HCWs",
                                                                                   "11-15 HCWs", 
                                                                                   "16-20 HCWs",
                                                                                   "21-25 HCWs",
                                                                                   "26-30 HCWs",
                                                                                   "More than 30 HCWs"))

#Create factor variables and re-level day 2
contact_June_22$Q62_factor <- factor(contact_June_22$Q62, ordered=TRUE, levels = c("Less than 5 patients", 
                                                                                   "5-9 patients",
                                                                                   "10-19 patients",
                                                                                   "20-29 patients",
                                                                                   "30-39 patients",
                                                                                   "More than 40 patients"))

contact_June_22$Q63_factor <- factor(contact_June_22$Q63, ordered=TRUE, levels = c("Less than 5 minutes", 
                                                                                   "5-10 minutes", 
                                                                                   "11-20 minutes", 
                                                                                   "More than 20 minutes"))

contact_June_22$Q64_factor <- factor(contact_June_22$Q64, ordered=TRUE, levels = c("Less than 5 patients",
                                                                                   "6-10 patients",
                                                                                   "11-15 patients", 
                                                                                   "16-20 patients", 
                                                                                   "More than 20 patients"))

contact_June_22$Q65_factor <- factor(contact_June_22$Q65, ordered=TRUE, levels = c("Less than 5 HCWs", 
                                                                                   "6-10 HCWs", 
                                                                                   "11-15 HCWs", 
                                                                                   "16-20 HCWs",
                                                                                   "21-25 HCWs",
                                                                                   "26-30 HCWs",
                                                                                   "More than 30 HCWs"))

# order building so it makes some sense 
contact_June_22$building_factor <- factor(contact_June_22$building, ordered=FALSE, 
                                          levels = c( "20 York St",
                                                      "ED",
                                                      "NP",
                                                      "WP", 
                                                      "SP",
                                                      "EP",
                                                      "55 Park St",
                                                      "YPH",
                                                      "Adjacent Clinic",
                                                      "SRC",
                                                      "Off site"))

# order building so it makes some sense 
contact_June_22$building_factor_D2 <- factor(contact_June_22$building_D2, ordered=FALSE, 
                                          levels = c( "20 York St",
                                                      "ED",
                                                      "NP",
                                                      "WP", 
                                                      "SP",
                                                      "EP",
                                                      "55 Park St",
                                                      "YPH",
                                                      "Adjacent Clinic",
                                                      "SRC",
                                                      "Off site"))


# convert contact age range contact 1 to factor

contact_June_22$Q40_1_factor <- factor(contact_June_22$X1_Q40, ordered=TRUE, levels = c("1 to 9 years old", 
                                                                                        "10 to 19 years old", "
                                                                                        20 to 29 years old",
                                                                                        "30 to 39 years old",
                                                                                        "40 to 49 years old",
                                                                                        "50 to 59 years old",
                                                                                        "60 to 69 years old",
                                                                                        "70 to 79 years old",
                                                                                        "80 years and older",
                                                                                        ""))



```


If people worked in more than 1 pavilion in Hospital 1 then summarized to all Hospital 1

# Charateristics of COVID-19 exposure 14 days before sensor week 

```{r sx_past_mo_June_22, echo=FALSE}

# 66 without symptoms in past month, 31 with some symptoms 

Symptoms_past_month<- contact_June_22 %>%
   filter(Q6_bin ==1) %>%
   dplyr::select(c(HCWID,Q6))

Symptoms_past_month <-Symptoms_past_month %>%              
  separate_rows(Q6, sep=",")   #symptoms long format

Symptoms_past_month <- Symptoms_past_month %>%
  mutate(Q6 = case_when(
    str_detect(Q6, pattern = "Are there other") ~ "Other",
    str_detect(Q6, pattern = "Cough") ~ "Cough",
    str_detect(Q6, pattern = "Unusually hoarse") ~ "Hoarse voice",
    str_detect(Q6, pattern = "Objective") ~ "Fever >100.4 F",
    TRUE ~ Q6))

#generate ggplot

Symptoms_past_month%>%   
  ggplot(aes(x=fct_infreq(Q6), fill=fct_infreq(Q6)))+
  geom_bar()+
  theme_classic()+
  ggtitle("Symptoms reported in month prior to Sensor Week")+
  xlab("Symptoms reported in past month")+
  ylab("N Symptoms Reproted ")+
  scale_x_discrete(guide = guide_axis(angle = 45)) +
   theme(legend.key.height= unit(3, 'mm'),
        legend.key.width= unit(3, 'mm'),
        legend.title=element_blank())
#2 other were post nasal drip and allergies

#Q7 In the past 14 days, did any member of your household also experience any of these symptoms?
 # 9 had family members with symptoms

#Graph of symptoms shared by family members
contact_June_22%>%   
  filter(Q7 == "Yes")%>%
  separate_rows(Q6, sep=",") %>%  #symptoms long format
   mutate(Q6 = case_when(str_detect(Q6, pattern = "Are there other") ~ "Other",
    str_detect(Q6, pattern = "Cough") ~ "Cough",
    str_detect(Q6, pattern = "Unusually hoarse") ~ "Hoarse voice",
    str_detect(Q6, pattern = "Objective") ~ "Fever >100.4 F",
    TRUE ~ Q6))%>% # make variable names better
  ggplot(aes(x=fct_infreq(Q6), fill=fct_infreq(Q6)))+
  geom_bar()+
  theme_classic()+
  ggtitle("Symptoms reported in month prior to Sensor Week in housheold members \n of HCWs who had symptoms")+
  xlab("Symptoms reported in past month")+
  ylab("N Symptoms Reproted ")+
  scale_x_discrete(guide = guide_axis(angle = 45)) +
   theme(legend.key.height= unit(3, 'mm'),
        legend.key.width= unit(3, 'mm'),
        legend.title=element_blank())
#this question isn't super helpful since it was only asked of those who already entered into active phase

#Q8 On average, how long was the duration of the most recent episode of illness?
 # 9 had family members with symptoms

```


```{r contact_June_22_illness_b4_sensor_week, echo=FALSE}
contact_June_22 %>% 
  dplyr::filter(!is.na(Q8))%>%
  dplyr::select(Q7,Q8,Q9)%>%
  tbl_summary(
    label = list(
      Q7 ~"Household members with illness", 
      Q8 ~ "Duration of illness",
      Q9 ~ "Worked while symptomatic"),
    sort = all_categorical() ~ "frequency")%>%
   modify_caption("Table 4. Illness characteristics before sensor week")
```

**31** individuals reported symptoms in the past month, of these **23** showed up for work with symptoms and **9** reported family members also had respiratory symptoms, but I'm not sure how useful that is considering people enrolled all at different times. 
                
                
```{r COVID_exposure_B4_sensor_week, echo=FALSE}
#Q10 In the past 14 days, how many shifts have you worked on a unit where there was a confirmed COVID-19 patient?

contact_June_22 %>% 
  dplyr::select(Q10,Q11,Q16)%>%
  tbl_summary(
    label = list(
      Q10 ~"Shifts works with a confirmed COVID-19 patient on the unit",    
      Q11 ~"Code Blue with a COVID-19 patient",
      Q16 ~"Within 6 feet of an intubation of a COVID-19 patient"
    )
  )%>%
   modify_caption("Table 4. COVID Exposure past 14 days")
  
  #Q12 is homes times, 2 ppl had 1-5 times, another had 0 times

```

Of those 3 who participated in a Code Blue, none did chest compression, 1 assisted in medication administration, 1 performed chest auscultation. Of the 5 who were within 6 feet of the intubation procedure, this happened between 1-5 times in the past 14 days. PPE question is out of date (has "ors" not "ands") so not including it. 



Table 1 of those included in the 2 day final analysis:
```{r Table_1_compelte, echo=FALSE}

t2 <- demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn) %>%
  tbl_summary(label = list(
      age ~"Age (years)",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino (Yes)",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
       Department_overall_sum ~ "Department",
      n_household ~ "N household members",
       n_household_gr18 ~ "N household members over the age of 18",
       hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
   modify_caption("Table 1a. Demographics Sensor Week -competed diary")

#Create combined table of enrollment demographics and completion of diary response
tbl_merge(
    tbls = list(t1, t2),
    tab_spanner = c("**Participation**", "**Completed Intensive Diary**")
  )


# intensive diary by job 
demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum, Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn) %>%
  tbl_summary(by ="Job_overall_sum",
    label = list(
      age ~"Age (years)",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino (Yes)",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
       Department_overall_sum ~ "Department",
      n_household ~ "N household members",
       n_household_gr18 ~ "N household members over the age of 18",
       hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
   add_overall() %>%
   modify_caption("Table supplementX. Demographics Sensor Week -competed diary by Job Sum")


```




```{r day_summary, echo=FALSE}

day_summary  <-contact_June_22 %>% 
  dplyr::select(c("HCWID", 
                  "in_out",
                  "Day1_day_week",
                  "Q21_factor",
                  "Q22_factor", 
                  "Q23_factor", 
                  "Q24_factor",
                  "Q26",
                  "Q27", 
                  "Q19",
                  "Q20",
                  "building_factor",
                  "building_sum","X1_Q34")) %>%
  dplyr:: rename(day_week = Day1_day_week,
                 ) %>%
  mutate(day = "Day 1")



#day 2 summary with same column names as day 1 
day_2_summary <- contact_June_22 %>%
  dplyr::select(c("HCWID",
                  "Day2_day_week", 
                  "Q60",
                  "Q61",
                  "Q62_factor",
                  "Q63_factor",
                  "Q64_factor",
                  "Q65_factor",
                  "Q67",
                  "Q68", 
                  "in_out_d2",
                  "building_factor_D2",
                  "building_sum_D2",
                  "X1_Q75")) %>%
  dplyr::rename(day_week = Day2_day_week,
                Q19 = Q60,
                Q20 = Q61,
                Q21_factor = Q62_factor,
                Q22_factor = Q63_factor,
                Q23_factor  = Q64_factor,
                Q24_factor = Q65_factor,
                in_out = in_out_d2,
                building_factor= building_factor_D2,
                building_sum =building_sum_D2,
                X1_Q34 = X1_Q75,
                Q26 = Q67,
                Q27 =Q68) %>%
  mutate(day = "Day 2")


# join day 1 and day 2
day_summary <- bind_rows(day_summary, day_2_summary)

#dim(day_2_summary) # 97 15 day  vs 97 x 15 = 194 x 15 correct bind


# make table of day 1 vs day 2
day_summary %>%
  dplyr::select(-c(HCWID))%>%
  tbl_summary(
    by = day,
    label = list(
                in_out ~ "Worked inpatient or outpatient",
                day_week ~ "Day dairy completed",
                Q21_factor ~ "N patients direct contact",
                Q22_factor ~ "Average minutes direct contact with patients",
                Q23_factor ~ "N patients indirect contact",
                Q24_factor ~ "N HCWs direct contact",
                Q26 ~ "N locations worked day 1",
                Q27 ~ "N hospitals worked day 1",
                Q19 ~ "Large group gathering (Yes)",
                Q20 ~"Total contacts day 1",
                building_factor ~ "Building worked in",
                building_sum ~ "Hospital worked in",
                X1_Q34 ~ "Hours worked"),
    sort = list(c(building_factor,building_sum) ~ "frequency"))%>%
   modify_caption("Table 5 . Detailed Participant characteristics by contact diary day")


#table 1 help: https://ehsanx.github.io/intro2R/data-summary-with-tableone.html 
#table 1 help https://cran.r-project.org/web/packages/furniture/vignettes/Table1.html

```

```{r total n contacts day 1 v 2, echo=FALSE, warning=FALSE}

#Q61 ""How many people including patients, coworkers, family, etc. did you come into contact with (as defined in the previous question) on Day 2? Please exclude people you could not identify in large groups.""

ggpairs(contact_June_22%>%
          dplyr::select(c("Q20", "Q61")), 
        aes(color = "#f768a1", alpha = 1, na.rm=TRUE),
        columnLabels = c("Total contacts day 1", "Total contacts day 2"))+
  ggtitle("Contacts Day 1 v Day 2")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```

```{r patients direct contact day 1 v day 2, echo=FALSE}
#Q 62 Approximately, how many patients were you in direct contact (within 6 feet) with on this day?


ggplot(contact_June_22, aes(Q62_factor, fill =Q21_factor))+
  geom_bar()+
  ggtitle("Direct Contacts with Patients Day 2 by Day 1")+
  theme_classic()+
  xlab("Direct patient contacts day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("Direct patient contacts day 1",palette ="RdPu") # lost ppl pretty equally across all contact types from day 1 to day 2, more than 40 were DEDECIATED!


```
*Direct contact defined here are contact within 6 feet*

```{r min_D1_v_D2, echo=FALSE}
#Q63: On average, how many minutes did you spend in direct contact with each patient (within 6 feet) on this day?


ggplot(contact_June_22, aes(Q63_factor, fill =Q22_factor))+
  geom_bar()+
  ggtitle("Minutes direct patient contact Day 2 v. Day 1")+
  theme_classic()+
  xlab("Minutes direct patient contacts day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("Min. direct patient contacts day 1",palette ="RdPu") # lost ppl pretty equally across all contact types from day 1 to day 2, more than 40 were DEDECIATED!

```

```{r indirect day 2, echo=FALSE}
#Q64 	On average, with how many patients did you have indirect contact (same room, i.e., not separated by a glass or wall partition, but more than 6 feet away) on this day?


ggplot(contact_June_22, aes(Q64_factor, fill =Q23_factor))+
  geom_bar()+
  ggtitle("N patients indirect contact Day 2 v. Day 1")+
  theme_classic()+
  xlab("N indirect patient contacts day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("N indirect patient contacts day 1",palette ="RdPu") # lost ppl pretty equally across all contact types from day 1 to day 2, more than 40 were DEDECIATED!

```

*Indirect contact was defined as being in the same room, i.e., not separated by a glass or wall partition, but more than 6 feet away.*



```{r av_HCW_contact, echo=FALSE}
#Q65 On average, with how many healthcare co-workers (HCW) did you have direct contact with (within 6 feet for at least two minutes, no glass or wall partition separating you) on this day?

ggplot(contact_June_22, aes(Q65_factor, fill =Q24_factor))+
  geom_bar()+
  ggtitle("HCW direct contact Day 2 v. Day 1")+
  theme_classic()+
  xlab("N direct contacts day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("N direct HCW contacts day 1",palette ="RdPu") # lost ppl pretty equally across all contact types from day 1 to day 2, more than 40 were DEDECIATED!

```

Contacts reported day 1 to day 2 overall relatively stable



```{r inptn outpn d1 d2, echo=FALSE}

#
ggplot(contact_June_22, aes(in_out_d2, fill =in_out))+
  geom_bar()+
  ggtitle("Participants worked inpatient v. outpatient day 1 v day 2")+
  theme_classic()+
  xlab("Location work day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("Location work day 1", palette ="RdPu") 
```



```{r buidling day 1 vs day 2, echo=FALSE}

#building day 1 vs day 2
ggplot(contact_June_22, aes(building_D2, fill =building))+
  geom_bar()+
  ggtitle("Building day 1 v day 2")+
  theme_classic()+
  xlab("Building work day 2")+
  ylab("count")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_hue("Building work day 1") 

```

Overall a large amount of stability in day 1 vs day 2 by building, some difference may be due to differences in filling out the survey,e.g. filling out "York St" one day and the "ED" the next day 


# Mosaic plots of contact type

```{r mosaic plot intesntiy vs fq direct patient contact and x2, echo=FALSE, warning = FALSE}

#Mosaic plot of number of patients and time spent with patients
ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Q22_factor), fill=Q21_factor)) + 
  ggtitle("Intensity v. frequency of contact of HCWs with patients")+
  xlab("Average mintues spent with patients on Day 1")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 6, angle =0, vjust = 1, hjust=1))+
  scale_fill_brewer("n patients direct contact",palette ="RdPu")

#mosaic plot help : https://cran.r-project.org/web/packages/ggmosaic/vignettes/ggmosaic.html

# re-do plot with n patients condensed

contact_June_22 %>%
  mutate(Q21_factor = case_when(Q21_factor=="20-29 patients"~"20 or more patients",
                                Q21_factor=="30-39 patients"~"20 or more patients",
                                Q21_factor=="More than 40 patients"~"20 or more patients",
    TRUE ~Q21_factor))%>% # not enough in 20 and up so re-level
   mutate(Q21_factor =factor(Q21_factor, levels = c("Less than 5 patients","5-9 patients","10-19 patients","20 or more patients")))  %>%#factor levels for age of contact
  ggplot() +
  geom_mosaic(aes(x = product(Q21_factor, Q22_factor), fill=Q21_factor)) + 
  ggtitle("Intensity v. frequency of contact of HCWs with patients")+
  xlab("Average mintues spent with patients on Day 1")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 6, angle =0, vjust = 1, hjust=1))+
  scale_fill_brewer("n patients direct contact",palette ="RdPu")


#create table of high fq contacts and demographics

demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q21_factor = contact_June_22$Q21_factor[match(HCWID, contact_June_22$HCWID)])%>%  # add column of  Q21_factor (fq of patient contact) from contact June by HCWID
  mutate(Q21_factor = case_when(Q21_factor=="20-29 patients"~"20 or more patients",
                                Q21_factor=="30-39 patients"~"20 or more patients",
                                Q21_factor=="More than 40 patients"~"20 or more patients",
    TRUE ~Q21_factor))%>% # not enough in 20 and up so re-level
    mutate(Q21_factor =factor(Q21_factor, levels = c("Less than 5 patients","5-9 patients","10-19 patients","20 or more patients")))  %>%#factor levels for age of contact
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn,Q21_factor) %>%
  tbl_summary(by=Q21_factor,
    label = list(
      age ~"Age",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
      Job_overall_sum ~"Jobs summarized",
       Department_overall_sum ~ "Department",
      n_household ~ "N household members",
       n_household_gr18 ~ "N household members over the age of 18",
       hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
   add_p(test.args = all_tests("fisher.test") ~ list(workspace=2e9)) %>%
   modify_caption("Table X: High patient count by demographics")
  


# table for Chi squared and residuals for duration by job detailed  
table_chisq <- demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q21_factor = contact_June_22$Q21_factor[match(HCWID, contact_June_22$HCWID)])%>%  # add column of  Q21_factor (fq of patient contact) from contact June by HCWID
  mutate(Q21_factor = case_when(Q21_factor=="20-29 patients"~"20 or more patients",
                                Q21_factor=="30-39 patients"~"20 or more patients",
                                Q21_factor=="More than 40 patients"~"20 or more patients",
    TRUE ~Q21_factor))%>% # not enough in 20 and up so re-level
    mutate(Q21_factor =factor(Q21_factor, levels = c("Less than 5 patients","5-9 patients","10-19 patients","20 or more patients")))  %>%#factor levels for age of contact
  dplyr::select(Job_sum,Q21_factor) %>%
  table()

chiasq <-chisq.test(table_chisq)
chiasq$stdres # look at residuals
corrplot(chiasq$stdres, is.corr = FALSE,cl.ratio=0.5)

# table for Chi squared and residuals for duration by job summary 

table_chisq <- demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q21_factor = contact_June_22$Q21_factor[match(HCWID, contact_June_22$HCWID)])%>%  # add column of  Q21_factor (fq of patient contact) from contact June by HCWID
  mutate(Q21_factor = case_when(Q21_factor=="20-29 patients"~"20 or more patients",
                                Q21_factor=="30-39 patients"~"20 or more patients",
                                Q21_factor=="More than 40 patients"~"20 or more patients",
    TRUE ~Q21_factor))%>% # not enough in 20 and up so re-level
    mutate(Q21_factor =factor(Q21_factor, levels = c("Less than 5 patients","5-9 patients","10-19 patients","20 or more patients")))  %>%#factor levels for age of contact
  dplyr::select(Job_overall_sum,Q21_factor) %>%
  table()

chiasq <-chisq.test(table_chisq)
chiasq$stdres # look at residuals
corrplot(chiasq$stdres, is.corr = FALSE,cl.ratio=0.5)


# add column by value https://stackoverflow.com/questions/64418540/simpler-r-code-for-adding-value-column-to-dataframe-based-on-id-column

```

```{r Q19_n_direct_ptn_long, echo=FALSE}
#create cor plot of longitudinal contacts 

t_Q19 <- months_short %>% # add variables you need from demographics
   mutate(age = demographic_June_22$age[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Gender = demographic_June_22$Gender[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Race_sum = demographic_June_22$Race_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Hispanic_Latino_sum = demographic_June_22$Hispanic_Latino_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Ed_factor = demographic_June_22$Ed_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(USA = demographic_June_22$USA[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Marriage_sum = demographic_June_22$Marriage_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Annual_income_factor = demographic_June_22$Annual_income_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(House_type_sum = demographic_June_22$House_type_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household = demographic_June_22$n_household[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household_gr18 = demographic_June_22$n_household_gr18[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(State = demographic_June_22$State[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_sum = demographic_June_22$Job_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_overall_sum = demographic_June_22$Job_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Department_overall_sum = demographic_June_22$Department_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Years_HCW_sum = demographic_June_22$Years_HCW_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(hours_hospital_sum = demographic_June_22$hours_hospital_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(COVID_ever = demographic_June_22$COVID_ever[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Vaccinated_COVID = demographic_June_22$Vaccinated_COVID[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Telecommute_yn = demographic_June_22$Telecommute_yn[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Q19 = case_when(Q19=="20 to 29"~"20 or more",
                                Q19=="30 to 39"~"20 or more",
                                Q19=="40 to 49"~"20 or more",
                                Q19=="More than 50"~"20 or more",
                         TRUE ~Q19))%>%
   mutate(Q19_factor =factor(Q19, levels = c("Less than 5","5 to 9","10 to 19","20 or more")))  %>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum,COVID_ever,Vaccinated_COVID,Q19_factor)%>%
   tbl_summary(by=Q19_factor,
      label = list(
        age ~"Age",
        Race_sum ~ "Race",
        Hispanic_Latino_sum ~"Hispanic/Latino",
        Ed_factor ~ "Education", #
        USA ~"Country of birth",
        Marriage_sum ~"Marital status",
        Years_HCW_sum ~"Years working as HCW",
        Annual_income_factor ~ "Annual income",
        House_type_sum ~ "House type",
        #Job_sum ~ "Job title",
        Job_overall_sum ~"Jobs summarized",
         Department_overall_sum ~ "Department",
        n_household ~ "N household members",
         n_household_gr18 ~ "N household members over the age of 18",
         hours_hospital_sum ~ "Average number of hours worked per week",
        COVID_ever ~ "History of COVID-19 at time of enrollment",
        Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment"
        ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
     modify_caption("Table X: High patient Direct contact by HCW demographics")

# combine 20 and up for Q19
# re-level factor 




#ideas for help here
#https://stats.stackexchange.com/questions/138510/how-to-predict-categorical-reponse
#https://journal.r-project.org/articles/RJ-2023-056/
#https://www.publichealth.columbia.edu/research/population-health-methods/repeated-measures-analysis
#https://www.sciencedirect.com/science/article/abs/pii/S0167947314000863



months_short  %>% dplyr::count(HCWID) %>%
  ggplot(aes(x=n))+
  geom_histogram()+
  geom_vline(aes(xintercept = median(n)), color = "red", linewidth = 2)+
  geom_vline(aes(xintercept = quantile(n, c(0.25))), color = "pink", linewidth = 1)+
  geom_vline(aes(xintercept = quantile(n, c(0.75))), color = "pink", linewidth = 1)


  
```


For longitudinal diaries, only  a **`r months_short  %>% dplyr::count(HCWID) %>% summarise(median = median(n, na.rm = TRUE))  `** median number of responses per HCW, IQR [ `r months_short  %>% dplyr::count(HCWID) %>% summarise(q_25= quantile(n, c(0.25),na.rm = TRUE))`-`r months_short  %>% dplyr::count(HCWID) %>% summarise(q_75= quantile(n, c(0.75),na.rm = TRUE))`]]



```{r Q20_time_patient_long, echo=FALSE}


t_Q20 <- months_short %>% # add variables you need from demographics
   mutate(age = demographic_June_22$age[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Gender = demographic_June_22$Gender[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Race_sum = demographic_June_22$Race_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Hispanic_Latino_sum = demographic_June_22$Hispanic_Latino_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Ed_factor = demographic_June_22$Ed_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(USA = demographic_June_22$USA[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Marriage_sum = demographic_June_22$Marriage_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Annual_income_factor = demographic_June_22$Annual_income_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(House_type_sum = demographic_June_22$House_type_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household = demographic_June_22$n_household[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household_gr18 = demographic_June_22$n_household_gr18[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(State = demographic_June_22$State[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_sum = demographic_June_22$Job_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_overall_sum = demographic_June_22$Job_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Department_overall_sum = demographic_June_22$Department_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Years_HCW_sum = demographic_June_22$Years_HCW_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(hours_hospital_sum = demographic_June_22$hours_hospital_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(COVID_ever = demographic_June_22$COVID_ever[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Vaccinated_COVID = demographic_June_22$Vaccinated_COVID[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Telecommute_yn = demographic_June_22$Telecommute_yn[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Q20_factor =factor(Q20, levels = c("Less than 5","5 to 10","11 to 20","More than 20")))  %>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum,COVID_ever,Vaccinated_COVID,Q20_factor)%>%
   tbl_summary(by=Q20_factor,
      label = list(
        age ~"Age",
        Race_sum ~ "Race",
        Hispanic_Latino_sum ~"Hispanic/Latino",
        Ed_factor ~ "Education", #
        USA ~"Country of birth",
        Marriage_sum ~"Marital status",
        Years_HCW_sum ~"Years working as HCW",
        Annual_income_factor ~ "Annual income",
        House_type_sum ~ "House type",
        #Job_sum ~ "Job title",
        Job_overall_sum ~"Jobs summarized",
         Department_overall_sum ~ "Department",
        n_household ~ "N household members",
         n_household_gr18 ~ "N household members over the age of 18",
         hours_hospital_sum ~ "Average number of hours worked per week",
        COVID_ever ~ "History of COVID-19 at time of enrollment",
        Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment"
        ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
     modify_caption("Table X: High average time per patient by HCW demographics")




```


```{r Q21_n_indrect_patient_long, echo=FALSE}


t_Q21 <-  months_short %>% # add variables you need from demographics
   mutate(age = demographic_June_22$age[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Gender = demographic_June_22$Gender[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Race_sum = demographic_June_22$Race_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Hispanic_Latino_sum = demographic_June_22$Hispanic_Latino_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Ed_factor = demographic_June_22$Ed_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(USA = demographic_June_22$USA[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Marriage_sum = demographic_June_22$Marriage_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Annual_income_factor = demographic_June_22$Annual_income_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(House_type_sum = demographic_June_22$House_type_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household = demographic_June_22$n_household[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household_gr18 = demographic_June_22$n_household_gr18[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(State = demographic_June_22$State[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_sum = demographic_June_22$Job_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_overall_sum = demographic_June_22$Job_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Department_overall_sum = demographic_June_22$Department_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Years_HCW_sum = demographic_June_22$Years_HCW_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(hours_hospital_sum = demographic_June_22$hours_hospital_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(COVID_ever = demographic_June_22$COVID_ever[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Vaccinated_COVID = demographic_June_22$Vaccinated_COVID[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Telecommute_yn = demographic_June_22$Telecommute_yn[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Q21 = case_when(
     Q21=="16 to 20"~"More than 15",
     Q21=="21 to 25"~"More than 15",
     Q21=="26 to 30"~"More than 15",
     Q21=="More than 30"~"More than 15",
                         TRUE ~Q21))%>%
   mutate(Q21_factor =factor(Q21, levels = c("Less than 5","6 to 10","11 to 15","More than 15")))  %>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum,COVID_ever,Vaccinated_COVID,Q21_factor)%>%
   tbl_summary(by=Q21_factor,
      label = list(
        age ~"Age",
        Race_sum ~ "Race",
        Hispanic_Latino_sum ~"Hispanic/Latino",
        Ed_factor ~ "Education", #
        USA ~"Country of birth",
        Marriage_sum ~"Marital status",
        Years_HCW_sum ~"Years working as HCW",
        Annual_income_factor ~ "Annual income",
        House_type_sum ~ "House type",
        #Job_sum ~ "Job title",
        Job_overall_sum ~"Jobs summarized",
         Department_overall_sum ~ "Department",
        n_household ~ "N household members",
         n_household_gr18 ~ "N household members over the age of 18",
         hours_hospital_sum ~ "Average number of hours worked per week",
        COVID_ever ~ "History of COVID-19 at time of enrollment",
        Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment"
        ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
     modify_caption("Table X: High indrect contacts with patient by HCW demographics")

```



```{r Q22_n_HCW_dir_long, echo=FALSE}

t_Q22 <- months_short %>% # add variables you need from demographics
   mutate(age = demographic_June_22$age[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Gender = demographic_June_22$Gender[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Race_sum = demographic_June_22$Race_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Hispanic_Latino_sum = demographic_June_22$Hispanic_Latino_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Ed_factor = demographic_June_22$Ed_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(USA = demographic_June_22$USA[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Marriage_sum = demographic_June_22$Marriage_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Annual_income_factor = demographic_June_22$Annual_income_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(House_type_sum = demographic_June_22$House_type_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household = demographic_June_22$n_household[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household_gr18 = demographic_June_22$n_household_gr18[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(State = demographic_June_22$State[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_sum = demographic_June_22$Job_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_overall_sum = demographic_June_22$Job_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Department_overall_sum = demographic_June_22$Department_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Years_HCW_sum = demographic_June_22$Years_HCW_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(hours_hospital_sum = demographic_June_22$hours_hospital_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(COVID_ever = demographic_June_22$COVID_ever[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Vaccinated_COVID = demographic_June_22$Vaccinated_COVID[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Telecommute_yn = demographic_June_22$Telecommute_yn[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Q22 = case_when(
     Q22=="21 to 25"~"More than 20",
     Q22=="26 to 30"~"More than 20",
     Q22=="More than 30"~"More than 20",
                         TRUE ~Q22))%>%
   mutate(Q22_factor =factor(Q22, levels = c("Less than 5","6 to 10","11 to 15","16 to 20","More than 20")))  %>%
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum,COVID_ever,Vaccinated_COVID,Q22_factor)%>%
   tbl_summary(by=Q22_factor,
      label = list(
        age ~"Age",
        Race_sum ~ "Race",
        Hispanic_Latino_sum ~"Hispanic/Latino",
        Ed_factor ~ "Education", #
        USA ~"Country of birth",
        Marriage_sum ~"Marital status",
        Years_HCW_sum ~"Years working as HCW",
        Annual_income_factor ~ "Annual income",
        House_type_sum ~ "House type",
        #Job_sum ~ "Job title",
        Job_overall_sum ~"Jobs summarized",
         Department_overall_sum ~ "Department",
        n_household ~ "N household members",
         n_household_gr18 ~ "N household members over the age of 18",
         hours_hospital_sum ~ "Average number of hours worked per week",
        COVID_ever ~ "History of COVID-19 at time of enrollment",
        Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment"
        ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
     modify_caption("Table X: High direct contact with other HCWs by HCW participant demographics")


```


```{r Q29_long, echo=FALSE}

t_Q29 <- months_short %>% # add variables you need from demographics
   mutate(age = demographic_June_22$age[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Gender = demographic_June_22$Gender[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Race_sum = demographic_June_22$Race_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Hispanic_Latino_sum = demographic_June_22$Hispanic_Latino_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Ed_factor = demographic_June_22$Ed_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(USA = demographic_June_22$USA[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Marriage_sum = demographic_June_22$Marriage_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Annual_income_factor = demographic_June_22$Annual_income_factor[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(House_type_sum = demographic_June_22$House_type_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household = demographic_June_22$n_household[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(n_household_gr18 = demographic_June_22$n_household_gr18[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(State = demographic_June_22$State[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_sum = demographic_June_22$Job_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Job_overall_sum = demographic_June_22$Job_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Department_overall_sum = demographic_June_22$Department_overall_sum[match(HCWID, demographic_June_22$HCWID)])%>%
  mutate(Years_HCW_sum = demographic_June_22$Years_HCW_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(hours_hospital_sum = demographic_June_22$hours_hospital_sum[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(COVID_ever = demographic_June_22$COVID_ever[match(HCWID, demographic_June_22$HCWID)])%>%
   mutate(Vaccinated_COVID = demographic_June_22$Vaccinated_COVID[match(HCWID, demographic_June_22$HCWID)])%>%
     mutate(Telecommute_yn = demographic_June_22$Telecommute_yn[match(HCWID, demographic_June_22$HCWID)])%>%
  dplyr::select(Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum,COVID_ever,Vaccinated_COVID,Q29)%>%
   tbl_continuous(variable=Q29,
      label = list(
        Race_sum ~ "Race",
        Hispanic_Latino_sum ~"Hispanic/Latino",
        Ed_factor ~ "Education", #
        USA ~"Country of birth",
        Marriage_sum ~"Marital status",
        Years_HCW_sum ~"Years working as HCW",
        Annual_income_factor ~ "Annual income",
        House_type_sum ~ "House type",
        #Job_sum ~ "Job title",
        Job_overall_sum ~"Jobs summarized",
         Department_overall_sum ~ "Department",
        n_household ~ "N household members",
         n_household_gr18 ~ "N household members over the age of 18",
         hours_hospital_sum ~ "Average number of hours worked per week",
        COVID_ever ~ "History of COVID-19 at time of enrollment",
        Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment"
        )) %>%
     modify_caption("Table X: N contacts HCW participant demographics ")

#removed age from above since creates a massive table
#https://www.danieldsjoberg.com/gtsummary/articles/gallery.html
```


```{r combined_table_long, echo=FALSE}

tbl_merge(
    tbls = list(t_Q19, t_Q20, t_Q21, t_Q22, t_Q29),
    tab_spanner = c("**N Direct Patient contact**", 
                    "**Average Minutes with a Patient**",
                    "**N Indirect Patient contact**",
                    "**N Direct HCW contact**",
                    "**Average total contacts**")
  )

```


by examining residuals of X-squared SW/rehab/transport with greatest n patient contact, while lab, and mid level, other the least. Admin/sw was bimodal with both high and low contact. this is likely from SW being combined w admin (see detailed job break down)


```{r direct indirect patients}
#Mosaic plot of number of patients and time spent with patients
ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Q23_factor), fill=Q21_factor)) + 
  ggtitle("Direct and Indirect contact of HCWs with patients")+
  xlab("n Patients indirect contact")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(plot.title = element_text(size=21),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("n patients direct contact", palette = "RdPu")+
  coord_cartesian(clip = "off") +
  theme(axis.text.y = element_blank(),
        plot.margin = margin(t=5.5, r=5.5, b=5.5, l=30, unit="pt"))


ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Q23_factor), fill=Q21_factor)) + 
  ggtitle("Direct and Indirect contact of HCWs with patients")+
  xlab("n Patients indirect contact")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(plot.title = element_text(size=18),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("n patients direct contact", palette = "RdPu")+
  coord_cartesian(clip = "off") 


fisher.test(contact_June_22$Q21_factor,contact_June_22$Q23_factor,workspace = 2e8)

#mosaic plot help : https://cran.r-project.org/web/packages/ggmosaic/vignettes/ggmosaic.html
# come back and fix colors 
#pallete help: http://rstudio-pubs-static.s3.amazonaws.com/5312_98fc1aba2d5740dd849a5ab797cc2c8d.html

```
**note** Large percentage of people with low amount of indirect and direct patient contact, could be a sampling bias towards those with less patient care 


```{r direct patients vs hcw direct contact,echo=FALSE }
#Mosaic plot of number of patients and time spent with patients
ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Q24_factor), fill=Q21_factor)) + 
  ggtitle("HCWs direct contact with patients and other HCWs")+
  xlab("n HCWs direct contact")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("n patients direct contact", palette = "RdPu")
```



#Mosaic plots by job
```{r, echo=FALSE, warning = FALSE}

ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Job), fill=Q21_factor)) + 
  ggtitle("N direct patient contact by job")+
  xlab("Job")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 6, angle =1, vjust = 0, hjust=1))+
  scale_fill_brewer("N patients direct contact",palette = "RdPu")


ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q21_factor, Job_overall_sum), fill=Q21_factor)) + 
  ggtitle("N direct patient contact by job")+
  xlab("Job")+
  ylab("n Patients direct contact")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 6, angle =1, vjust = 0, hjust=1))+
  scale_fill_brewer("N patients direct contact",palette = "RdPu")

```

```{r jov vs intesnity and x2, echo=FALSE}

ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q22_factor, Job), fill=Q22_factor)) + 
  ggtitle("Duration of contact with patients by job")+
  xlab("Duration patient contact")+
  ylab("Minutes Patients direct contact")+
  theme_classic()+
  theme( plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 20),
        axis.text.x = element_text(size= 9,angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 8, angle =0, vjust = 1, hjust=1)
        )+
  scale_fill_brewer("Duration of patient contat ", palette = "RdPu")

ggplot(data = contact_June_22) +
  geom_mosaic(aes(x = product(Q22_factor, Job_overall_sum), fill=Q22_factor)) + 
  ggtitle("Duration of contact with patients by job")+
  xlab("Duration patient contact")+
  ylab("Minutes Patients direct contact")+
  theme_classic()+
  theme( plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 20),
        axis.text.x = element_text(size= 9,angle = 45, vjust = 1, hjust=1),
        axis.text.y = element_text(size = 8, angle =0, vjust = 1, hjust=1)
        )+
  scale_fill_brewer("Duration of patient contat ", palette = "RdPu")



demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q22_factor = contact_June_22$Q22_factor[match(HCWID, contact_June_22$HCWID)])%>%  # add column of  Q22_factor (fq of patient contact) from contact June by HCWID
  dplyr::select(age,Gender, Race_sum,Hispanic_Latino_sum,Ed_factor,USA,Marriage_sum,Annual_income_factor, House_type_sum, n_household,n_household_gr18,State,Job_sum,Job_overall_sum,Department_overall_sum,Years_HCW_sum, hours_hospital_sum, flu_vax,COVID_ever,Vaccinated_COVID,Telecommute_yn,Q22_factor) %>%
  tbl_summary(by=Q22_factor,
    label = list(
      age ~"Age",
      Race_sum ~ "Race",
      Hispanic_Latino_sum ~"Hispanic/Latino",
      Ed_factor ~ "Education", #
      USA ~"Country of birth",
      Marriage_sum ~"Marital status",
      Years_HCW_sum ~"Years working as HCW",
      Annual_income_factor ~ "Annual income",
      House_type_sum ~ "House type",
      Job_sum ~ "Job title",
      Job_overall_sum ~"Jobs summarized",
       Department_overall_sum ~ "Department",
      n_household ~ "N household members",
       n_household_gr18 ~ "N household members over the age of 18",
       hours_hospital_sum ~ "Average number of hours worked per week",
      flu_vax ~ "Flu vaccine",
      COVID_ever ~ "History of COVID-19 at time of enrollment",
      Vaccinated_COVID ~ "Vaccinated for COVID-19 at time of enrollment",
      Telecommute_yn ~ "Ever tele-worked"
      ),
    missing = "no",
     sort = list(-c(Ed_factor,Annual_income_factor,n_household,n_household_gr18,hours_hospital_sum) ~ "frequency")) %>%
   add_p(test.args = all_tests("fisher.test") ~ list(workspace=2e9)) %>%
   modify_caption("Table X: Duration of patient contact by demographics")

# https://scholarworks.umass.edu/pare/vol20/iss1/8/



# table for Chi squared and residuals for duration by job detailed  
table_chisq <- demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q22_factor = contact_June_22$Q22_factor[match(HCWID, contact_June_22$HCWID)])%>%  # add column of  Q22_factor (fq of patient contact) from contact June by HCWID
  dplyr::select(Job_sum,Q22_factor) %>%
  table()

chiasq <-chisq.test(table_chisq)
chiasq$stdres # look at residuals
corrplot(chiasq$stdres, is.corr = FALSE,cl.ratio=.5)

# table for Chi squared and residuals for duration by job summary 
table_chisq <- demographic_June_22 %>% 
   dplyr::filter(HCWID %in% contact_June_22$HCWID)%>%
   mutate(Q22_factor = contact_June_22$Q22_factor[match(HCWID, contact_June_22$HCWID)])%>% # add column of  Q22_factor (fq of patient contact) from contact June by HCWID
  dplyr::select(Job_overall_sum,Q22_factor) %>%
  mutate(Q22_factor)%>%
  table()
  
chiasq <-chisq.test(table_chisq)
chiasq$stdres # look at residuals
corrplot(chiasq$stdres, is.corr = FALSE,cl.ratio=.5)


```


Which jobs had the greatest duration of patient contact? By examining residuals of x-squred plots: Rehab/transpor/imaging and nurses with greatest contact time with patients (similar when look at more detailed version of jobs with those 3 the most correlated with patient duration of contact ) and lab/admin with less than 5 minutes.

Though lab workers might have less direct contact, they likely still have important exposure to lab specimens that can represent their own biohazard depending on the pathogen

```{r Basic Histograms,echo=FALSE }
# #number of physical locations worked- R skewed


#number of hours worked- skewed
ggplot(data = contact_June_22) +
  geom_histogram(aes(X1_Q34, fill="#c51b8a"), binwidth = 1)  +
  ggtitle("The number hours worked on day 1")+
  xlab("")+
  ylab("hours")+
  theme_classic()+
  guides(fill="none")


```



** number of contacts by building**

```{r building, echo=FALSE}
# building
ggplot(data = contact_June_22) +
  geom_bar(aes(building_factor,fill=building_sum)) +
  ggtitle("Building worked in day 1")+
  xlab("Building")+
  ylab("n")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_brewer("Major Building Footprint", palette = "RdPu")

# can re-do the colors later
# location by contacts
ggplot(data = contact_June_22) +
  geom_boxplot(aes(x=building_factor,y=Q20,fill=building_factor))+
  ggtitle("# Contacts by Building Day 1")+
  xlab("Building")+
  ylab("n")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_discrete("Building")

#by job
ggplot(data = contact_June_22) +
  geom_boxplot(aes(x=Job,y=Q20,fill=Job))+
  ggtitle("# Contacts by JobDay 1")+
  xlab("Job")+
  ylab("n")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_discrete(" Job")


```


#  social contact matrices
Moving beyond the summary data reported in the contact diaries, we will now examine the individual contacts reported this can be created by the below code from contact_June_22, however this can also be read in as a seprate csv that has already been cleaned 

```{r matrix_clean, include = FALSE}
##the below is cleaning code, it is not needed if your read in contact_june_22_long_clean.csv
# 
# 
# 
# #create dataframe of contact data day 1 in long from pat 1 of questions
# contact_d1_q45 <- contact_June_22 %>%
#   dplyr::select(HCWID,X1_Q37:X50_Q45) 
# # %>%
# #   left_join(Age, by = "HCWID")
#   #add age
# 
# #rename columns so can do full join with the "_"
# colnames(contact_d1_q45) <- gsub("Q42_16_TEXT", "Q4216", colnames(contact_d1_q45))
# colnames(contact_d1_q45) <- gsub("Q42_18_TEXT", "Q4218", colnames(contact_d1_q45))
# 
# contact_d1_q45 <-contact_d1_q45%>%
#   mutate(X14_Q4218=as.character(X14_Q4218))
# 
# 
# contact_d1_q45 <- contact_d1_q45 %>% 
#   pivot_longer(-HCWID,
#                names_to = c("number",".value"),
#                names_pattern = "(.+)_(.+)")
# 
# 
# 
# #dim(contact_d1_q45)#4400 x 13
# 
# #######
# 
# contact_d1_q58 <- contact_June_22 %>%
#   dplyr::select(HCWID,X1_Q49:X50_Q58) 
# 
# 
#  # 97 x 601m repeat q 12 columns
# 
# 
# #rename columns so can do full join with the "_"
# colnames(contact_d1_q58) <- gsub("Q55_6_TEXT", "Q556", colnames(contact_d1_q58))
# colnames(contact_d1_q58) <- gsub("Q55_7_TEXT", "Q557", colnames(contact_d1_q58))
# 
# #pivot longer
# contact_d1_q58<-contact_d1_q58 %>% 
#   pivot_longer(-HCWID,
#                names_to = c("number",".value"),
#                names_pattern = "(.+)_(.+)") 
# 
# #dim(contact_d1_q58) #4400 x 14 
# 
# # combine contact_d1_q45 and contact_d1_q58
# 
# #rename columns contact_d1_q58 to match  contact_d1_q45 
# 
# contact_d1_q58 <- contact_d1_q58 %>%
#   dplyr::select(-c(Q50))
# 
# names(contact_d1_q58) <- c("HCWID", "number","Q37", "Q38","Q39", "Q40","Q41","Q42", "Q4216","Q4218","Q43","Q44","Q45" )
# 
# contact_d1 <- bind_rows(contact_d1_q45,contact_d1_q58)%>%
#   dplyr::filter(!is.na(Q40))%>% #take out NAs
#   mutate(Q40 =factor(Q40, levels = c("Less than 1 year old",
#                                      "1 to 9 years old",
#                                      "10 to 19 years old",
#                                      "20 to 29 years old", 
#                                      "30 to 39 years old",
#                                      "40 to 49 years old",
#                                      "50 to 59 years old",
#                                      "60 to 69 years old",
#                                      "70 to 79 years old",
#                                      "80 years and older")))  %>%#factor levels for age of contact 
#   mutate(Q43 = factor(Q43, levels = c("Less than 5 minutes",
#                                       "Between 5 to 15 minutes", 
#                                       "Between 15 minutes to 1 hour", 
#                                       "Between 1 hour to 4 hours",
#                                       "More than 4 hours")))
# 
# contact_d1$number <- substring(contact_d1$number,2) #remove x in front of "number"
# 
# contact_d1$day <- 1 #add day column
# 
# # 4850   13 + 4850   13 = 9700 x 13, correct number of rows in bind, becomes 1478 rows after removal of NA rows 
# 
# # help here https://www.riinu.me/2022/01/wide-to-long-multiple/
# 
# 
# #dim(contact_d1) # 1430 x 14

```




```{r contact_d2, include=FALSE}
##the below is cleaning code, it is not needed if your read in contact_june_22_long_clean.csv

# #create dataframe of contact data day 2 in long from pat 1 of questions
# contact_d2_q78_q88 <- contact_June_22 %>%
#   dplyr::select(HCWID,X1_Q78:X50_Q88) 
# 
# #rename columns so can do full join with the "_"
# colnames(contact_d2_q78_q88) <- gsub("Q85_13_TEXT", "Q8513", colnames(contact_d2_q78_q88))
# colnames(contact_d2_q78_q88) <- gsub("Q85_14_TEXT", "Q8514", colnames(contact_d2_q78_q88))
# 
# 
# contact_d2_q78_q88 <- contact_d2_q78_q88 %>% 
#   pivot_longer(-HCWID,
#                names_to = c("number",".value"),
#                names_pattern = "(.+)_(.+)")
# 
# 
# # 97 x 651 to 4850  15- looks good
# table(contact_June_22$Q89) # 8 ppl to enter more contacts
# table(contact_June_22$Q90) # adding 1,2 ,3,8,13,23 more contacts
# 
# # remove extra column from day 2 part 1 contacts 
# contact_d2_q78_q88 <- contact_d2_q78_q88 %>%
#   dplyr::select(-c(Q80)) 
# 
# #create dataframe of contact data day 2 in long from pat 2 of questions
# contact_d2_q92_q101 <- contact_June_22 %>%
#   dplyr::select(HCWID,X1_Q92:X50_Q101) 
# 
#  # 97 x 601m repeat q 12 columns
# 
# 
# #rename columns so can do full join with the "_"
# colnames(contact_d2_q92_q101) <- gsub("Q98_17_TEXT", "Q9817", colnames(contact_d2_q92_q101))
# colnames(contact_d2_q92_q101) <- gsub("Q98_18_TEXT", "Q9818", colnames(contact_d2_q92_q101))
# 
# #pivot longer
# contact_d2_q92_q101<-contact_d2_q92_q101 %>% 
#   pivot_longer(-HCWID,
#                names_to = c("number",".value"),
#                names_pattern = "(.+)_(.+)") 
# 
# # dim 97 601 to dim 4850  x 14
# 
# # combine contact_d2_q78_q88 and contact_d2_q92_q101
# #rename columns contact_d2_q92_q101 to match  contact_d2_q78_q88 
# names(contact_d2_q92_q101) <- c("HCWID", "number","Q78", "Q79","Q81", "Q82","Q83","Q84", "Q85","Q8513","Q8514","Q86", "Q87","Q88")
# 
# 
# contact_d2 <- bind_rows(contact_d2_q78_q88,contact_d2_q92_q101)%>%
#   filter(!is.na(Q78))%>% #take out blank rows
#   mutate(Q83 =factor(Q83, 
#                      levels = c("Less than 1 year old",
#                                 "1 to 9 years old","10 to 19 years old",
#                                 "20 to 29 years old", 
#                                 "30 to 39 years old",
#                                 "40 to 49 years old",
#                                 "50 to 59 years old",
#                                 "60 to 69 years old",
#                                 "70 to 79 years old",
#                                 "80 years and older")))  %>%#factor levels for age of contact 
#   mutate(Q86 = factor(Q86, 
#                       levels = c("Less than 5 minutes",
#                                  "Between 5 to 15 minutes", 
#                                  "Between 15 minutes to 1 hour", 
#                                  "Between 1 hour to 4 hours",
#                                  "More than 4 hours")))
# 
# #remove x in front of "number"
# contact_d2$number <- substring(contact_d2$number,2) 
# #add day column
# contact_d2$day <- 2
# dim(contact_d2) #1155 x 15
# 
# 
# #1155 observations of 16 variables from 4850 x 4850 before NAs removed
# 
# # help here https://www.riinu.me/2022/01/wide-to-long-multiple/
```



```{r contact bind, echo=FALSE}
# #the below is cleaning code, it is not needed if your read in contact_june_22_long_clean.csv
# # day 1 make variables prettier
# 
# #bind day 1 and day 2 
# contact_d1$Q79 <- NA # add column to day 1 "50 - Did you have contact with and record this person on your first day?" and make NAs
# contact_d2_prebind <- contact_d2 %>% 
#   dplyr::rename("Q37" = "Q78",
#                 "Q38" = "Q81",
#                 "Q39"  = "Q82",
#                 "Q40"  = "Q83",
#                 "Q41"="Q84", 
#                 "Q42"="Q85",
#                 "Q4216"= "Q8513",
#                 "Q4218"="Q8513",
#                 "Q43" = "Q86",
#                 "Q44"= "Q87",
#                 "Q45"= "Q88")
# 
# #binde day 1 and day 2 contact diaries 
# contact <- bind_rows(contact_d1,contact_d2_prebind)
# 
# #create contactinated row 
# contact<- contact %>%
#   unite("contact_id", c(HCWID,number,day), remove=FALSE)%>%
#   filter(contact_id != "HCW.1.0814_14_2")%>% # not elegant but it works, remove those entered in error
# filter(contact_id != "HCW.1.0814_15_2")%>%
# filter(contact_id != "HCW.1.0814_16_2")%>%
#   filter(contact_id != "HCW.1.0814_17_2")%>%
# filter(contact_id != "HCW.1.0814_18_2")%>%
#   filter(contact_id != "HCW.1.0814_19_2")%>%
#   filter(contact_id != "HCW.1.0814_20_2")%>%
#     filter(Q37 != "No one else for day 1")%>%
#   filter(Q37 != "Erroneous Entry")%>%
#   filter(Q37 != "Extraneous Entry")%>%
#   filter(Q37 != "n/a")%>%  # removed those that people put NA for, assuming those aren't really contacts
#   filter(Q37 != "N/A")%>%
#       filter(contact_id != "HCW.1.0788_1_1")%>%# remove 788 since they didn't complete 1 full diary 
#    filter(Q37 != "This is more than the 33 I said I needed to enter")%>%
#   filter(Q37 != "This survey is broken")%>%
#  filter(Q37 != "Why is it asking me about more than the 33 people that I said I was in contact with the first day?")%>% 
# #for 871 "husband of kari" will make day 1 contact #21 since the following entry says "no one else for day 1",though they didn't do a day 2 survey
#   mutate(number = case_when(Q37=="husband of kari"~"21", TRUE ~ number))
# 
# #clean up
# contact <- contact %>% 
#    mutate(Q38 = case_when( 
#      str_detect(Q38, pattern = "family member such as spouse") ~ "Household member", TRUE ~ Q38)) %>%
#   mutate(Q41 = case_when(
#     str_detect(Q41, pattern = "Direct proximity:") ~ "Direct proximity",
#     str_detect(Q41, pattern = "Non-physical contact: a two-way") ~ "Non-physical contact",
#     str_detect(Q41, pattern = "Physical contact: directly touching someone") ~ "Physical contact",
#     TRUE ~ Q41)) 
# 
# # day 1 make variables prettier
# contact <- contact %>% 
#    mutate(Q38 = case_when( # Make variables prettier
#      str_detect(Q38, pattern = "family member such as spouse") ~ "Household member", TRUE ~ Q38)) %>%
#   mutate(Q41 = case_when( # Make variables prettier
#     str_detect(Q41, pattern = "Direct proximity:") ~ "Direct proximity",
#     str_detect(Q41, pattern = "Non-physical contact: a two-way") ~ "Non-physical contact",
#     str_detect(Q41, pattern = "Physical contact: directly touching someone") ~ "Physical contact",
#     TRUE ~ Q41))  #remove extra entries
# 
# #clean up Q42 for location 
# contact  <- contact %>%
#   mutate(Q42_clean=case_when(
#     (Q42 =="Hospital,Other (work associated), please specify" & Q4218 =="11") ~ "Other (work associated)",
#     (Q42 =="Other (work associated), please specify" & Q4216 =="NICU") ~ "Hospital",
#      (Q42 =="Other (work associated), please specify" & Q4216 =="North Haven Office") ~ "Ambulatory setting",
#          (Q42 =="Other (work associated), please specify" & Q4216 =="North Haven Office") ~ "Ambulatory setting",
#          (Q42 =="Other (work associated), please specify" & Q4216 =="Medicine floor") ~ "Hospital",
#              (Q42 =="Other (work associated), please specify" & Q4216 =="99 Hawley Lane") ~ "Ambulatory setting",
#      (Q42 =="Ambulatory setting,Other (work associated), please specify" & Q4216 =="Project Access Office") ~ "Other (work associated)",
#          (Q42 =="Hospital,Emergency room") ~ "Hospital",
#          TRUE ~ Q42))
# 
# contact<- contact %>%
#   mutate(Q42_clean = case_when(
#     (Q42_clean=="Ambulatory setting" ~"Ambulatory"),
#       (Q42_clean=="Ambulatory Setting" ~"Ambulatory"),
#       (Q42_clean=="Ambulatory Setting,Home" ~"Ambulatory,Home"),
#       (Q42_clean=="Hospital,Ambulatory setting" ~"Hospital,Ambulatory"),
#       (Q42_clean=="Hospital,Ambulatory Setting" ~"Hospital,Ambulatory"),
#       (Q42_clean=="Hospital,Emergency Room" ~"Hospital,ER"),
#       (Q42_clean=="Emergency Room" ~"ER"),
#       (Q42_clean=="Emergency room" ~"ER"),
#       (Q42_clean=="Hospital,Other (non-work associated), please specify" ~"Hospital,Other (non-work associated)"),
#       (Q42_clean=="Hospital,Other (non-work associated), please specify:" ~"Hospital,Other (non-work associated)"),
#       (Q42_clean=="Hospital,Other (work associated), please specify" ~"Hospital,Other (work associated)"),
#       (Q42_clean=="Other (work associated), please specify" ~"Other (work associated)"),
#       (Q42_clean=="Other (non-work associated), please specify:" ~"Other (non-work associated)"),
#           (Q42_clean=="Other (non-work associated), please specify" ~"Other (non-work associated)"),
#     TRUE~Q42_clean
#   ))

```


```{r contact_june_22_long_clean, echo=FALSE}

#contact_june_22_long_clean.csv is created from cleaning contact_June_22

contact <- read.csv("contact_june_22_long_clean.csv")

contact <-contact %>%
  dplyr::select(-"X") #remoe extra column

#dim(contact) #2596 observations

contact %>% 
  dplyr::select(-c(contact_id,HCWID,number,Q37,Q4216,Q4218,Q79,Q8514,Q42)) %>%
  tbl_summary(
    by = day,
    label = list(Q38 ~"Relationship with contact",
                Q39 ~ "Contact gender",
                Q40 ~ "Contact estimated age",
                Q41 ~ "Contact type",
                Q43 ~ "Contact duration for 24-hour period",
                Q44 ~ "Frequency of contact",
                Q45 ~ "Was participant wearing a sensor",
                Q42_clean ~ "Contact location"),
    sort = list(-c(Q40,Q43) ~ "frequency"))%>%
   modify_caption("Table 8. Detailed contact characteristics")

head(contact)

# 

# Can also read in "contact_june_22_long_clean.csv" into "contact.csv" to avoid cleaning, but factors will need to be re-leveled

```


**`r nrow(contact)`** was the total number of contacts across 2 days that  were reported in detail.
Median number of contacts reported **`r median(table(contact$HCWID))/2`**, IQR [`r quantile(table(contact$HCWID),0.25)/2` - `r quantile(table(contact$HCWID),0.75)/2`].

Contact definitions for reference
**Physical contact**  This involves directly touching someone (skin-to-skin contact), or the clothes they are wearing intentionally or unintentionally (for example, a handshake, fist bump, elbow bump, foot bump, hug, kiss, etc.) 
**Non-physical contact**  This involves a two-way conversation with three or more words exchanged in the physical presence of another person (within 2 m or approximately 6 ft of each other), but with no physical contact. 
**Direct proximity**  This involves being within 6 feet of your contact for 20 seconds or more with neither conversation nor physical contact. 


#Figure 2

*Below code will make grouped boxplots and stacked bar charts to make figure 2*

Figure 2 legend: Individual reported contacts per day of HCWs are summarized from the 2 -day intensive contact diary as stacked barplots.

Figure 2B: Number of contacts per HCW per day by participant job and contact type (direct-proximity, non-physical or physical contact). 




```{r grouped_box_plot_job_contact_type_1, echo=FALSE, dpi=1000}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q41) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

#create table,divide Freq by 2 to account for over 2 days
contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q41 = (case_when(Q41=="Non-physical contact"~"Non-physical",
                            Q41=="Physical contact"~"Physical",
                               TRUE~Q41)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q41)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "B",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact type"))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
 

# add job to contact
# group by job and type of contact
# create ggplot box plot

#create table, divide by 2 as contact CSV over 2 days
contact_Q41 <- contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q41 = (case_when(Q41=="Non-physical contact"~"Non-physical",
                            Q41=="Physical contact"~"Physical",
                               TRUE~Q41)))%>%
    ungroup()%>% #remove HCID grouping variable
   dplyr::select(Q41, Freq, Job_sum)%>%
  mutate(Freq = Freq/2)
  
contact_Q41%>%
    tbl_continuous(variable = (Freq), by = Q41)%>%
    modify_spanning_header(all_stat_cols() ~ "**Contact Type**")%>%
    modify_caption("Table X: Contact type by Job; Sensor week")


# statst test of high-contact individuals
shapiro <- contact_Q41 %>% 
  dplyr::filter(Q41 =="Direct proximity")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.22, H0 not rejected 

#

shapiro <- contact_Q41 %>% 
  dplyr::filter(Q41 =="Non-physical")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
)
 # p=0.19, H0 not rejected 


shapiro <- contact_Q41 %>% 
  dplyr::filter(Q41 =="Physical")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 
# all above data are not-normal, will use Kruskal-Wallis as opposed to ANOVA

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.0017, H0  rejected 

#Post-Hoc Dun test

dunnTest(Freq ~ Job_sum,
  data = shapiro,
  method = "holm"
)

#Imaging Technologist - Laboratory P.adj 0..04772343 P.adj

#library(ggstatsplot)

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q41 = (case_when(Q41=="Non-physical contact"~"Non-physical",
                            Q41=="Physical contact"~"Physical",
                               TRUE~Q41)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q41, color=Q41)) +
  geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "B",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact"),
           color="none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

  
```


```{r stacked_bar_n_contacts_per_job_per_day, dpi=1000, echo=FALSE}
# create number of job  data frame
contact_job_stacked <- left_join(contact,job_df, by = "HCWID")%>% # add job
  dplyr::select(Job_sum, HCWID)%>%
  dplyr::distinct(HCWID, .keep_all=TRUE)%>%
  group_by(Job_sum) %>% # summarize by job
  dplyr::summarize(Freq=n()) # get frequency

#create n contacts data frame
contact_stacked <- left_join(contact,job_df, by = "HCWID")%>% # add job
  dplyr::select(Job_sum, HCWID,Q41)%>%
   group_by(Job_sum, Q41) %>% # type of contact by job
  dplyr::summarize(Freq=n())

contact_stacked <-left_join(contact_stacked,contact_job_stacked, by = "Job_sum") # add freq job
  #dplyr::mutate("Freq"="Freq.x"/"Freq.y")#divide Freq contact by freq job

contact_stacked$Freq <- round(contact_stacked$Freq.x/contact_stacked$Freq.y,1)


#ggplot of average contacts per participant by job per day 

contact_stacked%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q41 = (case_when(Q41=="Non-physical contact"~"Non-physical",
                            Q41=="Physical contact"~"Physical",
                               TRUE~Q41)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q41, color=Q41)) + # divide by 2 since to get contacts per day
  geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts per HCW",
    title = "B",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact type"),
           color="none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```

Figure 2A. Number of contacts per health care worker (HCW) per day by participant job and relationship to contact individual. 


```{r grouped_box_plot_job_contact_loc, dpi=1000, echo=FALSE}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q38) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Stranger",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q38)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "Number of contacts over 2 days by participant job and contact individual",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Stranger",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q38, color=Q38)) +
    geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "Number of contacts over 2 days by participant job and contact individual",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


# can clean up a bit
contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Other",
                           Q38=="Friend/acquaintance"~"Other",
                           Q38=="Household member"~"Other",
                            Q38=="Relative"~"Other",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q38)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "A",
    subtitle = ""    # legend title
  ) +

   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

#stacked bar
contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Other",
                           Q38=="Friend/acquaintance"~"Other",
                           Q38=="Household member"~"Other",
                            Q38=="Relative"~"Other",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q38, color=Q38)) +
   geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "A",
    subtitle = ""    # legend title
  ) +

   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


contact_Q38 <- contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Other",
                           Q38=="Friend/acquaintance"~"Other",
                           Q38=="Household member"~"Other",
                            Q38=="Relative"~"Other",
                               TRUE~Q38)))%>%
    ungroup()%>% #remove HCID grouping variable
   dplyr::select(Q38, Freq, Job_sum)%>%
   mutate(Freq = Freq/2) # divide by 2 since contacts were over 2 days

contact_Q38%>%
    tbl_continuous(variable = Freq, by = Q38)%>%
    modify_spanning_header(all_stat_cols() ~ "**Contact Type**")%>%
    modify_caption("Table X: Contact Relationship by Job; Sensor week")


# statst test of high-contact individuals
shapiro <- contact_Q38 %>% 
  dplyr::filter(Q38 =="Colleague")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.315, H0 not rejected for Colleague
     
# statst test of high-contact individuals
shapiro <- contact_Q38 %>% 
  dplyr::filter(Q38 =="Patient")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.1637, H0 not rejected for Colleague

# statst test of high-contact individuals
shapiro <- contact_Q38 %>% 
  dplyr::filter(Q38 =="Other")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.3793  , H0 not rejected for Colleague
     

#library(ggsignif)
#https://www.datanovia.com/en/blog/how-to-add-p-values-onto-a-grouped-ggplot-using-the-ggpubr-r-package/


```





```{r stacked_bar_type_contacts_per_job_per_day, dpi=1000, echo=FALSE}
#create n contacts data frame
contact_stacked <- left_join(contact,job_df, by = "HCWID")%>% # add job
  dplyr::select(Job_sum, HCWID,Q38)%>%
   group_by(Job_sum, Q38) %>% # type of contact by job
  dplyr::summarize(Freq=n())

contact_stacked <-left_join(contact_stacked,contact_job_stacked, by = "Job_sum") # add freq job
  #dplyr::mutate("Freq"="Freq.x"/"Freq.y")#divide Freq contact by freq job

contact_stacked$Freq <- round(contact_stacked$Freq.x/contact_stacked$Freq.y,1)
head(contact_stacked)
#ggplot of average contacts per participant by job per day 

#stacked bar contact type per day, dividied by n in job
contact_stacked%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
   mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Other",
                           Q38=="Friend/acquaintance"~"Other",
                           Q38=="Household member"~"Other",
                            Q38=="Relative"~"Other",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q38, color=Q38)) +
   geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "A",
    subtitle = ""    # legend title
  ) +

   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```

Figure 2C: Number of contacts per HCW per day by participant job and location of the contact.


```{r grouped_box_plot_job_contact_location_2, dpi=1000, echo=FALSE}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q42_clean) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

#clean and divde by 2 since over 2 days
contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q42_clean)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "C",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

#stacked bar
contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q42_clean, color = Q42_clean)) +
  geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "C",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

#create table and divide by 2

contact_Q42 <- contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
    ungroup()%>% #remove HCID grouping variable
  mutate(Freq = Freq/2)

contact_Q42%>%
   dplyr::select(Q42_clean, Freq, Job_sum)%>%
    tbl_continuous(variable = Freq, by = Q42_clean)%>%
    modify_spanning_header(all_stat_cols() ~ "**Contact Type**")%>%
    modify_caption("Table X: Contact location by Job; Sensor week")


# statst test of high-contact individuals
shapiro <- contact_Q42 %>% 
  dplyr::filter(Q42_clean =="Ambulatory")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.06861, H0 not rejected for Colleague
    
shapiro <- contact_Q42 %>% 
  dplyr::filter(Q42_clean =="ER")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.6447, H0 not rejected for Colleague

shapiro <- contact_Q42 %>% 
  dplyr::filter(Q42_clean =="Home")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.5839, H0 not rejected for Colleague

shapiro <- contact_Q42 %>% 
  dplyr::filter(Q42_clean =="Hospital")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.7349, H0 not rejected for Colleague

shapiro <- contact_Q42 %>% 
  dplyr::filter(Q42_clean =="Other")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.7349, H0 not rejected for Colleague
    

```
Other here: other work and non-work associated
here Hospital and ambulatory coded as ambulatory
hospital and other coded as hospital 
home and ambulatory coded as ambulatory
hospital and Er coded as ER 


Figure 2D: Number of contacts per HCW per day by participant job and duration of the contact


```{r stacked_bar_type_loc_per_job_per_day, dpi=1000}
#create n contacts data frame
contact_stacked <- left_join(contact,job_df, by = "HCWID")%>% # add job
  dplyr::select(Job_sum, HCWID,Q42_clean)%>%
   group_by(Job_sum, Q42_clean) %>% # type of contact by job
  dplyr::summarize(Freq=n())

contact_stacked <-left_join(contact_stacked,contact_job_stacked, by = "Job_sum") # add freq job
  #dplyr::mutate("Freq"="Freq.x"/"Freq.y")#divide Freq contact by freq job

contact_stacked$Freq <- round(contact_stacked$Freq.x/contact_stacked$Freq.y,1)
#ggplot of average contacts per participant by job per day 

#stacked bar
contact_stacked%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q42_clean, color = Q42_clean)) +
  geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "C",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```


```{r grouped_box_plot_job_contact_time, dpi=1000, echo=FALSE}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q43) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
  ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q43)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "D",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


contact_Q43 <- contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    ungroup()%>% #remove HCID grouping variable
  mutate(Freq = Freq/2)

contact_Q43%>%
   dplyr::select(Q43, Freq, Job_sum)%>%
    tbl_continuous(variable = Freq, by = Q43)%>%
    modify_spanning_header(all_stat_cols() ~ "**Contact Type**")%>%
    modify_caption("Table X: Contact time by Job; Sensor week")


# statst test of high-contact individuals
shapiro <- contact_Q43 %>% 
  dplyr::filter(Q43 =="Less than 5 minutes")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.06861, H0 not rejected for Colleague

# statst test of high-contact individuals
shapiro <- contact_Q43 %>% 
  dplyr::filter(Q43 =="Between 5 to 15 minutes")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p=0.2926, H0 not rejected for Colleague


# statst test of high-contact individuals
shapiro <- contact_Q43 %>% 
  dplyr::filter(Q43 =="Between 15 minutes to 1 hour")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p= 0.09868, H0 not rejected for Colleague

# statst test of high-contact individuals
shapiro <- contact_Q43 %>% 
  dplyr::filter(Q43 =="Between 1 hour to 4 hours")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p= 0.448, H0 not rejected for Colleague


# statst test of high-contact individuals
shapiro <- contact_Q43 %>% 
  dplyr::filter(Q43 =="More than 4 hours")

shapiro.test(shapiro$Freq) # P < 0.05, reject H0 of normal data, assume data is not normal 

kruskal.test(Freq ~ Job_sum,
  data = shapiro
) # p= 0.324, H0 not rejected for Colleague


    

```


```{r stacked_bar_type_time_per_job_per_day, echo=FALSE}
#create n contacts data frame
contact_stacked <- left_join(contact,job_df, by = "HCWID")%>% # add job
  dplyr::select(Job_sum, HCWID,Q43)%>%
   group_by(Job_sum, Q43) %>% # type of contact by job
  dplyr::summarize(Freq=n())

contact_stacked <-left_join(contact_stacked,contact_job_stacked, by = "Job_sum") # add freq job
  #dplyr::mutate("Freq"="Freq.x"/"Freq.y")#divide Freq contact by freq job

contact_stacked$Freq <- round(contact_stacked$Freq.x/contact_stacked$Freq.y,1)
#ggplot of average contacts per participant by job per day 


#
#stacked bar
contact_stacked%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                              Job_sum=="Administrative staff"~"Admin. staff",
                               TRUE~Job_sum)))%>%
  mutate(Q43 = (case_when(Q43=="Less than 5 minutes"~"Less than 5 minutes",
                           Q43=="Between 5 to 15 minutes"~"5 to 15 minutes",
                          Q43=="Between 15 minutes to 1 hour"~"15 minutes to 1 hour",
                          Q43=="Between 1 hour to 4 hours"~"1 hour to 4 hours",
                          Q43=="More than 4 hours"~"More than 4 hours",
                               TRUE~Q43)))%>%
  mutate(Q43=fct_relevel(Q43,c("More than 4 hours","1 hour to 4 hours","15 minutes to 1 hour","5 to 15 minutes","Less than 5 minutes"))) %>% #relevel
 ggplot(aes(x = Job_sum, y = (Freq/2), fill=Q43, color = Q43)) +
  geom_bar(position="stack", stat="identity")+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "D",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "),
          color = "none")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```


## Contact matrices

```{r contact matrices all contact, echo=FALSE}
#add HCW age to contact
contact$age <- age_df[match(contact$HCWID, age_df$HCWID),2] # add age 


# create same age break downs as in questions
contact <- contact %>%
  mutate(age_cat=cut(age, breaks=c(0, 1, 10, 20, 30, 40,50,60,70,80,Inf), 
                                                labels=c("[0-1)",
                                                         "[1-9)", 
                                                         "[10-19)",
                                                         "[20-29)",
                                                         "[30-39)",
                                                         "[40-49)",
                                                         "[50-59)",
                                                         "[60-69)",
                                                         "[70-79)",
                                                         "[>80)")))

contact$Q40_level <- recode(contact$Q40, "Less than 1 year old"= "[0-1)", 
                      "1 to 9 years old" ="[1-9)",
                       "10 to 19 years old" =  "[10-19)", 
                       "20 to 29 years old" =   "[20-29)",
                       "30 to 39 years old" ="[30-39)",
                       "40 to 49 years old"=  "[40-49)",
                       "50 to 59 years old" =  "[50-59)",
                       "60 to 69 years old" =   "[60-69)",
                       "70 to 79 years old" =   "[70-79)",
                       "80 years and older" = "[>80)")

#make data long format so can be read into geom_tile
long_prop <- data.frame(prop.table(table(
  HCW = contact$age_cat,
  contact = contact$Q40_level)))%>%
  mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #convert ages with no HCWs to NAs


```




```{r grouped_box_plot_job_age_part, echo=FALSE}
  

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, age_cat) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
  ggplot(aes(x = Job_sum, y = Freq, fill=age_cat)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "Number of contacts over 2 days by participant job and age",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


```



```{r grouped_box_plot_job_contact_location_1, echo=FALSE}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q42_clean) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

contact_fq%>%
  mutate(Job_sum = (case_when(Job_sum=="Diagnostic Imaging Technologist"~"Imaging Technologist",
                               TRUE~Job_sum)))%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
  ggplot(aes(x = Job_sum, y = Freq, fill=Q42_clean)) +
  geom_boxplot()+
  labs( x = "Participant Job",
    y = "Number of contacts",
    title = "C",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact "))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


```



```{r grouped_box_plot_in_out_location, echo=FALSE}

#add job to contact
contact_fq <- contact%>%
  group_by(HCWID, Q42_clean,Q38) %>% # type of contact by individual
   # add job column 
  dplyr::summarize(Freq=n())

#contact_fq<- left_join(contact_fq,job_df, by = "HCWID") # add job

contact_fq%>%
    mutate(Q42_clean = (case_when(Q42_clean=="Ambulatory,Home"~"Ambulatory",
                                  Q42_clean=="Hospital,ER"~"ER",
                                  Q42_clean=="Hospital,Home"~"Hospital",
                                  Q42_clean=="Hospital,Ambulatory"~"Ambulatory",
                                   Q42_clean=="Hospital,Other (non-work associated)"~"Hospital",
                                  Q42_clean=="Hospital,Other (work associated)"~"Hospital",
                                  Q42_clean=="Other (non-work associated)"~"Other",
                                   Q42_clean=="Other (work associated)"~"Other",
                               TRUE~Q42_clean)))%>%
      mutate(Q38 = (case_when(Q38=="Do not know this person personally, not a patient"~"Other",
                              Q38=="Friend/acquaintance"~"Other",
                               Q38=="Household member"~"Other",
                              Q38=="Relative"~"Other",
                               TRUE~Q38)))%>%
  ggplot(aes(x = Q38, y = Freq, fill=Q42_clean)) +
  geom_boxplot()+
  labs( x = "Contact",
    y = "Number of contacts",
    title = "Number of contacts over 2 days contact individual and location",
    subtitle = ""    # legend title
  ) +
   guides(fill=guide_legend(title="Contact Locataion"))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))


```


# Contact Matricies: All contact types


```{r within_contact_porportion, echo=FALSE}

contact_frequency <- contact %>%
 dplyr:: count(age_cat, Q40_level) %>%
 dplyr:: group_by(age_cat) %>% 
  mutate(total_age_HCW = sum(n))%>%
  ungroup()%>%
  mutate(Freq_HCW_age = n/total_age_HCW)

```



The mean within age-group proportions was **`r contact_frequency %>% dplyr::filter(age_cat == Q40_level)%>% summarise(mean(Freq_HCW_age))`** with a standard deviation of **`r contact_frequency %>%  dplyr::filter(age_cat ==Q40_level)%>% summarise(sd(Freq_HCW_age)) `**


Denser contact with colleagues in inpatient setting, denser contacts with patients in outpatient settings 
Other= stranger, friend acquaintance, household member, relative 



## Negative binomial of all contacts

Create a negative binomial model of total contacts over time (count data) accounting for calendar time and repeated measures by individual with a random effect for individual. Place here now that all variables have been cleaned.

```{r neg_binom, echo=FALSE}
regression<- months_short %>%
  filter(mo_yr != c("2020-11"))%>%
   filter(mo_yr != c("2022-07"))%>% #remove 1st and last month since only 2 respondents
   filter(mo_yr != c("2021-06"))%>% #remove months when study closed
     filter(mo_yr != c("2021-07"))%>%#remove months when study closed
  dplyr::select(c("HCWID","Q19":"Q22","Q29","Q31","mo_yr"))%>% #select HCWID, contact questions and contact n, select mo_yr
  filter(!is.na("Q31"))# remove NAs from total time 

#recreate levels from table 2
#Q19
regression <- regression%>%
  mutate(Q19 = case_when(Q19=="20 to 29"~"20 or more",
                                Q19=="30 to 39"~"20 or more",
                                Q19=="40 to 49"~"20 or more",
                                Q19=="More than 50"~"20 or more",
                         TRUE ~Q19))%>%
   mutate(Q19 = factor(Q19, ordered=TRUE, levels = c("Less than 5",
                                                     "5 to 9",
                                                     "10 to 19", 
                                                     "20 or more")))

#Q21
regression <- regression%>%
  mutate(Q21 = case_when(Q21=="16 to 20"~"More than 15",
                                Q21=="21 to 25"~"More than 15",
                                Q21=="26 to 30"~"More than 15",
                                Q21=="More than 20"~"More than 15",
                         TRUE ~Q21))%>%
   mutate(Q21 = factor(Q21, ordered=TRUE, levels = c("Less than 5",
                                                     "6 to 10",
                                                     "11 to 15", 
                                                     "More than 15")))

#Q22
regression <- regression%>%
  mutate(Q22 = case_when(Q22=="21 to 25"~"More than 20",
                                Q22=="26 to 30"~"More than 20",
                                Q22=="More than 30"~"More than 20",
                         TRUE ~Q22))%>%
   mutate(Q22 = factor(Q22, ordered=TRUE, levels = c("Less than 5",
                                                     "6 to 10",
                                                     "11 to 15",
                                                     "16 to 20",
                                                     "More than 20")))



regression$age <- age_df[match(regression$HCWID, age_df$HCWID),2] # add age 
regression$sex <- sex_df[match(regression$HCWID, sex_df$HCWID),2] # add sex 
regression$job <- job_df[match(regression$HCWID, job_df$HCWID),2] # add job 
regression$dept <- dept_df[match(regression$HCWID, dept_df$HCWID),2] # add depart 



#n contacts by group
regression %>% 
  group_by(job)%>%
  dplyr::summarise(mean =mean(Q31, na.rm=TRUE))

#check for overdisperion 


#https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
#https://stats.oarc.ucla.edu/r/dae/negative-binomial-regression/
#https://rpubs.com/Shaunson26/offsetglm

# Jobs a/w higher total contact: N contacts more than nursing aids:
# Diagnostic imaging `r exp(summary(m1)$coefficients[3,1])`
# MD `r exp(summary(m1)$coefficients[5,1])`
# Lab `r exp(summary(m1)$coefficients[6,1])`
# Midlevel `r exp(summary(m1)$coefficients[7,1])`
# Nurse `r exp(summary(m1)$coefficients[8,1])`


```



```{r neg_binomial_time_spline, echo=FALSE}
#create time splines, df = degrees of freedom
regression$mo_yr_n<- ym(regression$mo_yr)

#Nursing Aide and SW with lowest contacts, make NA reference (greater n)
regression <- regression%>%
  mutate(job = case_when(job=="Nursing Aid"~"AANursing Aid",
                         TRUE ~job))

time_splines <- ns(regression$mo_yr_n, df = 1)#

m3 <- glmer.nb(Q31 ~ job + time_splines+ (1|HCWID), data = regression, verbose=TRUE,
             glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) 

#anova(m2,m3)# 3233.5

# #1 DF splines
# time_splines <- ns(regression$mo_yr_n, df = 6)#
# 
# m4 <- glmer.nb(Q31 ~ job + time_splines+ (1|HCWID), data = regression, verbose=TRUE,
#              glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000))) 
# anova(m3,m4)# 3235.3 

# M3 with 1 DOF best
summary(m3)
tbl_regression(m3, exponentiate =TRUE)%>%
  modify_column_hide(columns = p.value)


```




```{r Q19_regression, echo=FALSE}
#Q19: On average, how many patients were you in direct contact (within 6 feet) with on this day?


regression %>% 
  dplyr::select(job, Q19)%>%
  table # nurse with most less than 5, make nurse reference


#re-level
regression <- regression%>%
  mutate(job = case_when(job=="AANursing Aid"~"Nursing Aid",
                         job=="Laboratory"~"AALaboratory",
                         TRUE ~job))
#  #update splines
# time_splines <- ns(regression$mo_yr_n, df = 5)
# 
# m1 <- clmm(Q19 ~ job +time_splines+(1|HCWID), data = regression)
# summary(m1) #AIC 921.66 
# 
#  #update splines
# time_splines <- ns(regression$mo_yr_n, df = 3)
# m2 <- clmm(Q19 ~ job + time_splines +(1|HCWID), data = regression)
# anova(m1,m2) # M2 better, AIC 918.13 

#update splines
time_splines <- ns(regression$mo_yr_n, df = 1)
m3<- clmm(Q19 ~ job + time_splines +(1|HCWID), data = regression)
#anova(m2,m3) # M2 and M3, go with M3 since fewer terms better,  AIC 918.13

# #update splines
# time_splines <- ns(regression$mo_yr_n, df = 2)
# m4<- clmm(Q19 ~ job +sex + time_splines +(1|HCWID), data = regression)
# anova(m3,m4) # M3 better,  AIC   921.25

summary(m3)
tbl_regression(m3)%>%
  modify_column_hide(columns = p.value) # hide p value

```

For Q19: On average, how many patients were you in direct contact (within 6 feet) with on this day: All with greater direct contacts than lab workers  (other than admin workers)



```{r Q20_regression, echo=FALSE}
#Q20:On average, how many minutes did you spend in direct contact with any one patient (within 6 feet) on this day?

regression %>% 
  dplyr::select(job, Q20)%>%
  table # nurse with most less than 5, make nurse reference

# #re-level, try with MD since has better distribution, won't run with Laboratory
# regression <- regression%>%
#   mutate(job = case_when(job=="AALaboratory"~"Laboratory",
#                          job=="Doctor"~"AADoctor",
#                          TRUE ~job))


regression <- regression%>%
  mutate(job = case_when(job=="Laboratory"~"AALaboratory",
                         job=="AADoctor"~"Doctor",
                         TRUE ~job))


# time_splines <- ns(regression$mo_yr_n, df = 5)
# m1 <- clmm(Q20 ~ job +time_splines+(1|HCWID), data = regression)
# summary(m1) #  1019.2
# 
# time_splines <- ns(regression$mo_yr_n, df = 3)
# m2 <- clmm(Q20 ~ job +time_splines+(1|HCWID), data = regression)
# anova(m1,m2) # m2 better AIC 1015.6
# 
time_splines <- ns(regression$mo_yr_n, df = 1)
m3 <- clmm(Q20 ~ job +time_splines+(1|HCWID), data = regression)
#anova(m3,m2) # m3 better AIC 1011.7

# time_splines <- ns(regression$mo_yr_n, df = 2)
# m4 <- clmm(Q20 ~ job +time_splines+(1|HCWID), data = regression)
# anova(m4,m3) # m3 better AIC 1013.6

# time_splines <- ns(regression$mo_yr_n, df = 4)
# m5 <- clmm(Q20 ~ job +time_splines+(1|HCWID), data = regression)
# anova(m4,m5) # m4 better AIC013.63 -

#tbl_regression(m1)

#m2 <- clmm(Q20 ~ job +sex +(1|HCWID)+(1|mo_yr), data = regression)
#anova(m1,m2) # M1 better


tbl_regression(m3)%>%
  modify_column_hide(columns = p.value) # hide p value

summary(m3)

```
Q20:On average, how many minutes did you spend in direct contact with any one patient (within 6 feet) on this day?: more for all than lab workers except admin




```{r Q21_regression, echo=FALSE}
#Q21: On average, with how many patients did you have indirect contact (same room but not closer than 6 feet) on this day?
regression %>% 
  dplyr::select(job, Q21)%>%
  table # nurse with most less than 5, make nurse reference

#re-level, even with
regression <- regression%>%
  mutate(job = case_when(job=="Nurse"~"AANurse",
                         job=="AALaboratory"~"Laboratory",
                         TRUE ~job))
# even with re-leveling, still errors:1) Hessian is numerically singular: parameters are not uniquely determined In addition: Absolute convergence criterion was met, but relative criterion was not met"" 

time_splines <- ns(regression$mo_yr_n, df = 1)
m1 <- clmm(Q21 ~ job +time_splines+(1|HCWID), data = regression)
summary(m1)

#tbl_regression(m1)

# #add dept- still doesn't converge 
# m1 <- clmm(Q21 ~ job +dept+time_splines+(1|HCWID), data = regression)
# summary(m1)


# m2 <- clmm(Q21 ~ job+sex +(1|HCWID)+(1|mo_yr), data = regression)
# summary(m2)

```
For indirect patient contact "(1) Hessian is numerically singular: parameters are not uniquely determined In addition: Absolute convergence criterion was met, but relative criterion was not met"" 


```{r Q22_regression, echo=FALSE}
#Q22: N HCWs
regression %>% 
  dplyr::select(job, Q22)%>%
  table # nurse with most less than 5, make nurse reference


regression %>% 
  dplyr::select(dept, Q22)%>%
  table # nurse with most less than 5, make nurse reference


regression <- regression%>%
    mutate(dept = case_when(dept=="Pediatrics"~"AAPediatrics",
                         TRUE ~dept)) #Peds as reference


time_splines <- ns(regression$mo_yr_n, df = 1)
m1 <- clmm(Q22 ~ job +time_splines+(1|HCWID), data = regression)
summary(m1) # AIC 11251.0
tbl_regression(m1)


# time_splines <- ns(regression$mo_yr_n, df = 3)
# m2<- clmm(Q22 ~ job +time_splines+(1|HCWID), data = regression)
# anova(m1,m2) #AIC 1253.3, M1 better

# #sensitivity analysis add department
# m3 <- clmm(Q22 ~ job +dept+time_splines+(1|HCWID), data = regression)
# summary(m3)
# tbl_regression(m3)


#clmm::anova(m1,m2)#not sure why ANOVA isn't working here 
#AIC lower in M1 ( 1327 vs 1370)

```

Differences for HCW contact not different by job (regardless of if age controlled for or not)

Though when accounting for department, with pediatrics as reference, EM Department had higher contact with other HCWs.

## Contact Matrices

The below plots show the overall proportion of contacts, not the within age group range for contacts.


```{r summary_long_prop}

long_prop %>%
  dfSummary(
    graph.col = TRUE,
    style = "grid",
    graph.magnif = 0.75
  ) %>%
  stview()




```



```{r contact_matrix_porp_marginal}

## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
   # title = "Contact matrix-- All contact types",
   # subtitle = "Frequency matrix of contact events (n = 2,596)",
    fill = "Proportion all \ncontacts"     # legend title
  )+
  theme(plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 18),
        legend.direction = "horizontal" #make lengend horizontal for later
        ) 

gg_rows <-long_prop%>%
  aggregate(Freq~HCW,sum, na.action = na.pass)%>%
  ggplot(aes(x=HCW, y=Freq))+
  geom_bar(stat='identity', color="dark grey", fill="white") +
  labs(x="")+
    theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()
#might need to add NAs here 


gg_cols <-long_prop%>%
  aggregate(Freq~contact,sum)%>%
  ggplot(aes(x=contact, y=round(Freq,digits=2)))+
  geom_bar(stat='identity',color="dark grey", fill="white") +
  labs (y="Freq",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(6,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(3,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)

grid.newpage()
grid.draw(g)


# # not aligning, try anther way
# #p <- qplot(1,1)
# g <- ggplotGrob(gg_hm + theme(legend.position="none"))
# 
# panel_id <- g$layout[g$layout$name == "panel",c("t","l")]
# 
# g <- gtable_add_cols(g, unit(5,"cm"))
# g <- gtable_add_grob(g, ggplotGrob(gg_cols),
#                      t = panel_id$t, l = ncol(g))
# 
# g <- gtable_add_rows(g, unit(5,"cm"), 0)
# g <- gtable_add_grob(g, ggplotGrob(gg_rows),
#                      t = 1, l = panel_id$l)
# 
# grid.newpage()
# grid.draw(g)
# https://stackoverflow.com/questions/38856309/r-grid-arrange-marginal-plots-to-ggplot2-heatmap-geom-tile


```


```{r contact_matrix_porp}

#make contact matrix, all  contacts day 1 and 2 by porp 
ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- All contact types",
    subtitle = "Frequency matrix of contact events (n = 2,596)",
    fill = "Proportion all \ncontact events"     # legend title
  )+
  theme(plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 18) 
        ) 



# make contact matrix ,, all contacts day 1 and 2  by n contacts

# #make data long format so can be read into geom_tile
# long_c <- contact %>%
#   dplyr::select(age_cat,Q40_level)%>%
#   dplyr::count(age_cat,Q40_level, name ="Count")
#   
# 

# %>%
#   mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #convert ages with no HCWs to NAs

#all contacts day 1
long_prop <- contact %>%
  filter(day =="1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
  mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq))
  #make NA for HCWs age 0-19 and >70


ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix--Day 1 all contact types",
    subtitle = "Frequency matrix of contact events (n = 1,466)",
    fill = "Proportion all \ncontact events"     # legend title
  )

#all contacts day 2
long_prop <- contact %>%
  filter(day =="2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
  mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas


ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix--Day 2 all contact types",
    subtitle = "Frequency matrix of contact events (n = 1,130)",
    fill = "Proportion all \ncontact events"     # legend title
  )

#https://epirhandbook.com/en/heat-plots.html
```


# Physical contact
```{r Physical contact}

#by physical contact
long_prop <- contact %>%
  filter(Q41=="Physical contact")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
   mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas


ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
    geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix --  Physcial contact",
    subtitle = "Frequency matrix of contact events (n=477)",
    fill = "Proportion physcial \ncontact events"     # legend title
  )


#by physical contact day 1
long_prop <- contact %>%
  filter(Q41=="Physical contact") %>%
  filter(day == "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
     mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
    geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 1--  Physcial contact",
    subtitle = "Frequency matrix of contact events (n=266)",
    fill = "Proportion physcial \ncontact events"     # legend title
  )


#by physical contact day 2
long_prop <- contact %>%
  filter(Q41=="Physical contact") %>%
  filter(day == "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
     mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
    geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2--  Physcial contact",
    subtitle = "Frequency matrix of contact events (n=211)",
    fill = "Proportion physcial \ncontact events"     # legend title
  )


```



# Non-physical contact
```{r non-physcial, echo=FALSE}

#by non-physical contact
long_prop <- contact %>%
  filter(Q41=="Non-physical contact")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
       mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
      geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix--  Non-physcial contact",
    subtitle = "Frequency matrix of contact events (n=1,790)",
    fill = "Proportion non-physcial \ncontact events"     # legend title
  )

#by non-physical contact day1
long_prop <- contact %>%
  filter(Q41=="Non-physical contact")%>%
  filter(day == "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
       mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
      geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix--  Non-physcial contact Day 1",
    subtitle = "Frequency matrix of contact events (n=985)",
    fill = "Proportion non-physcial \ncontact events"     # legend title
  )

#by non-physical contact day2
long_prop <- contact %>%
  filter(Q41=="Non-physical contact")%>%
  filter(day == "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
       mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
      geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix--  Non-physcial contact Day 2",
    subtitle = "Frequency matrix of contact events (n=805)",
    fill = "Proportion non-physcial \ncontact events"     # legend title
  )

```


# Direct proximity
```{r direct proximity, echo=FALSE}

#by Direct proximity
long_prop <- contact %>%
  filter(Q41=="Direct proximity")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
    mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Direct proximity",
    subtitle = "Frequency matrix of contact events (n=329)",
    fill = "Proportion \n events"     # legend title
  )

#by Direct proximity day 1
long_prop <- contact %>%
  filter(Q41=="Direct proximity") %>%
  filter(day == "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level))) %>%
    mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 1-- Direct proximity",
    subtitle = "Frequency matrix of contact events (n=215)",
    fill = "Proportion \n events"     # legend title
  )

#by Direct proximity day 2
long_prop <- contact %>%
  filter(Q41=="Direct proximity") %>%
  filter(day == "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
    mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Direct proximity",
    subtitle = "Frequency matrix of contact events (n=114)",
    fill = "Proportion \n events"     # legend title
  )


```



# Location of contact

```{r ER contact, echo=FALSE}
#ER contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="ER"|Q42_clean=="Hospital,ER" ) # any ER contact

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix ER contact",
    subtitle = "Frequency matrix of contact events (n=196)",
    fill = "Proportion \n events"     # legend title
  )
```




```{r ambulatory contact, echo=FALSE}
#Ambulatory contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="Ambulatory"|Q42_clean=="Ambulatory,Home"| Q42_clean=="Hospital,Ambulatory") #Any ambulatory contact

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Ambulatory contact",
    subtitle = "Frequency matrix of contact events (n=481)",
    fill = "Proportion \n events"     # legend title
  )
```


```{r home contact, echo=FALSE}
#Home contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="Home"|Q42_clean=="Hospital,Home"|Q42_clean=="Ambulatory,Home" )  # any Home contact

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Home contact",
    subtitle = "Frequency matrix of contact events (n=200)",
    fill = "Proportion \n events"     # legend title
  )

```


```{r Hospital contact, echo=FALSE}
#Hospital contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="Hospital"|Q42_clean=="Hospital,Home" | Q42_clean=="Hospital,Ambulatory"| Q42_clean=="Hospital,ER"| Q42_clean=="Hospital,Other (non-work associated)"| Q42_clean=="Hospital,Other (work associated)") # any Hospital contact


long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Hospital contact",
    subtitle = "Frequency matrix of contact events (n=1,566)",
    fill = "Proportion \n events"     # legend title
  )

```

```{r Contact other work assoc, echo=FALSE}

#Other work associated contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="Other (work associated)"| Q42_clean=="Hospital,Other (work associated)") # any Other contact

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix other work associated contact",
    subtitle = "Frequency matrix of contact events (n=222)",
    fill = "Proportion \n events"     # legend title
  )


#Other non-work associated contact (any contact)
long_prop <- contact %>%
  filter(Q42_clean=="Hospital,Other (non-work associated)"| Q42_clean=="Other (non-work associated)") # any Hospital contact

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix non-work associated contact",
    subtitle = "Frequency matrix of contact events (n=45)",
    fill = "Proportion \n events"     # legend title
  )



```

**note** When "other" location not clear, I condescend into hospital when = "other" treated like a means to provide more detail . HCWID 0366 worked in a rapid eval clinic in the cancer hospital (NP11), how to classify this? I just changed to "Other (work associated)" due to its location, similar with NP4 Lab draw (outpatient practice in inpatient building). Project access kept as "other" since not a clinic but a social support office. 

**note** total N of contact matrices based on location will not sum to total N of contacts overall since overlapping contacts counted by individual location (e.g. "Ambulatory and Home" contacted placed both into "Amubulatory" and "Home" matrix)




 Patient v. co-woker
```{r Patient v co-woker_relative_other matrix, echo = FALSE}

# Colleague contact
long_prop <- contact %>%
  filter(Q38=="Colleague")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix with colleagues",
    subtitle = "Frequency matrix of contact events (n=1,613)",
    fill = "Proportion \n events"     # legend title
  )+
    theme(plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 18) 
        ) 


# Patient contact
long_prop <- contact %>%
  filter(Q38=="Patient")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix with patients",
    subtitle = "Frequency matrix of contact events (n=589)",
    fill = "Proportion \n events"     # legend title
  )+
  theme(plot.title = element_text(size = 20), 
        plot.subtitle = element_text(size = 18) 
        ) 

# household contact
long_prop <- contact %>%
  filter(Q38=="Household member")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix with household member",
    subtitle = "Frequency matrix of contact events (n=145)",
    fill = "Proportion \n events"     # legend title
  )

# other contact
long_prop <- contact %>%
  filter(Q38=="Friend/acquaintance"|Q38=="Relative"|Q38=="Do not know this person personally, not a patient")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix with friends, relative, other",
    subtitle = "Frequency matrix of contact events (n=249)",
    fill = "Proportion \n events"     # legend title
  )

```




# Contact by gender

```{r gender, echo=FALSE}
#add participant sex 
contact$sex <- sex_df[match(contact$HCWID, sex_df$HCWID),2] # add sex 

#Female participants
long_prop <- contact %>%
  filter(sex=="Female")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Female participants ",
    subtitle = "Frequency matrix of contact events (n=2,184)",
    fill = "Proportion \n contact events"     # legend title
  )
# similar to overall, due to most participants are F

#male participants
long_prop <- contact %>%
  filter(sex=="Male")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Male participants ",
    subtitle = "Frequency matrix of contact events (n=412)",
    fill = "Proportion \n contact events"     # legend title
  )


#male participants day 1
long_prop <- contact %>%
  filter(sex=="Male") %>%
  filter(day == "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Male participants Day 1 ",
    subtitle = "Frequency matrix of contact events (n=250)",
    fill = "Proportion \n contact events"     # legend title
  )

#male participants day 2
long_prop <- contact %>%
  filter(sex=="Male") %>%
  filter(day == "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Male participants Day 2",
    subtitle = "Frequency matrix of contact events (n=162)",
    fill = "Proportion \n contact events"     # legend title
  )

```
Female participants similar to overall contact matrix, though male participant contact matrix with greater data sparsity. 



# Female Contacts
```{r female, echo = FALSE}

#Female contacts
long_prop <- contact %>%
  filter(Q39=="Female")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Female contacts ",
    subtitle = "Frequency matrix of contact events (n=1730)",
    fill = "Proportion \n contact events"     # legend title
  )

#Female contacts day 1
long_prop <- contact %>%
  filter(Q39=="Female") %>%
  filter(day == "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 1-- Female contacts ",
    subtitle = "Frequency matrix of contact events (n=978)",
    fill = "Proportion \n contact events"     # legend title
  )

  
#Female contacts day 2
long_prop <- contact %>%
  filter(Q39=="Female") %>%
  filter(day == "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Female contacts ",
    subtitle = "Frequency matrix of contact events (n=752)",
    fill = "Proportion \n contact events"     # legend title
  )



```


# Male Contacts

```{r Male, echo=FALSE}
#Male
long_prop <- contact %>%
  filter(Q39=="Male")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix-- Male contacts ",
    subtitle = "Frequency matrix of contact events (n=843)",
    fill = "Proportion \ncontact events"     # legend title
  )


#Male day 1
long_prop <- contact %>%
  filter(Q39=="Male") %>%
  filter(day== "1")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 1-- Male contacts ",
    subtitle = "Frequency matrix of contact events (n=476)",
    fill = "Proportion \ncontact events"     # legend title
  )


#Male day 2
long_prop <- contact %>%
  filter(Q39=="Male") %>%
  filter(day== "2")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Male contacts ",
    subtitle = "Frequency matrix of contact events (n=367)",
    fill = "Proportion \ncontact events"     # legend title
  )

```


```{r female participant and contact, echo=FALSE}

#Female participants and female contact
long_prop <- contact %>%
  filter(Q39=="Female") %>%
  filter(sex== "Female")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Female contact and participants ",
    subtitle = "Frequency matrix of contact events (n=1471)",
    fill = "Proportion \ncontact events"     # legend title
  )

#Female participants and male contact
long_prop <- contact %>%
  filter(Q39=="Male") %>%
  filter(sex== "Female")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Female contact and participants ",
    subtitle = "Frequency matrix of contact events (n=691)",
    fill = "Proportion \ncontact events"     # legend title
  )


#Male participants and female contact
long_prop <- contact %>%
  filter(Q39=="Female") %>%
  filter(sex== "Male")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Male contact and participants ",
    subtitle = "Frequency matrix of contact events (n=259)",
    fill = "Proportion \ncontact events"     # legend title
  )
#Male contact and participants 
long_prop <- contact %>%
  filter(Q39=="Male") %>%
  filter(sex== "Male")

long_prop <- as.data.frame(prop.table(table(HCW = long_prop$age_cat,contact = long_prop$Q40_level)))%>%
      mutate(Freq=ifelse(HCW==c("[0-1)","[1-9)","[10-19)","[70-79)","[>80)"),NA,Freq)) #make Nas

ggplot(long_prop, aes(x = HCW, y = contact, fill = Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)))+
  scale_fill_distiller(palette = "YlGnBu") +
  labs( x = "Health care worker age",
    y = "Contact age",
    title = "Contact matrix Day 2-- Male contact and participants ",
    subtitle = "Frequency matrix of contact events (n=152)",
    fill = "Proportion \ncontact events"     # legend title
  )


```


## Contact mMtrices by N contact 
(if using n contact then add NAs to HCWs age < 19 and > 70)

Figure 3 legend: The x-axis shows the HCW age with non-working ages greyed out (e.g., less than 20, greater than 70) and the y-axis shows the estimated contact age. Each tile is filled and colored with the average number of contacts per HCW of that age-range with contact of that age-range per day. A horizontal marginal histogram of each contact matrix shows the age distribution of HCWS and a vertical marginal histogram the age distribution of contacts   Please note each plot has a different scale, this is to preserve the ability to discriminate different values. A: Average contacts of HCWs with all individuals per day (n=2,550). 


```{r facet_n_contact_1, dpi=1000, echo=FALSE}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact  # max is 2550

#make data frame of ages of contact
age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table() #88

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days

age_cat <- as.data.frame(age_cat) # make data frame
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()




#might need to add NAs here 

# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()

## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]


## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))
g

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))

## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)

grid.newpage()
grid.arrange(g, top= "A")



```

 D: Average physical contacts per day (n=462). 

```{r facet_n_contact_physcial_contact, dpi=1000, echo=FALSE}

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q41=="Physical contact")
# dim(n_cont) # 468

#make data frame of ages of contact 
age_cont <- as.data.frame(table(n_cont$Q40_level))
age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q41=="Physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame age of HCWS
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()

gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "D")


```

B: Average non-physical contacts per day (n=1,754). 

```{r facet_n_contact_nonphyical_contact, dpi=1000}

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q41=="Non-physical contact")
# dim(n_cont) # 468

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q41=="Non-physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs


age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "B")

```

E: Average direct proximity contacts per day (n=328). 

```{r facet_n_contact_direct_prox_contact, dpi=1000, echo=FALSE}

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q41=="Direct proximity")
# dim(n_cont) # 468

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q41=="Direct proximity")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs
  

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 
# 
# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "E")

```



```{r facet_n_contact_ER_contact, dpi=1000, echo=FALSE}

## 1) Colleague contact and participants 
n_cont <- contact %>%
   filter(Q42_clean=="ER"|Q42_clean=="Hospital,ER" ) 


age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
    filter(Q42_clean=="ER"|Q42_clean=="Hospital,ER" ) %>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs
  
age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts in ER (n=196)")

```


```{r facet_n_contact_hospital_contact, dpi=1000}

## 1) Colleague contact and participants 
n_cont <- contact %>%
   filter(Q42_clean=="Hospital"|Q42_clean=="Hospital,ER"|Q42_clean=="Hospital,Ambulatory"|Q42_clean=="Hospital,Home"|Q42_clean=="Hospital,Other (non-work associated)"|Q42_clean=="Hospital,Other (work associated)" ) 
# dim(n_cont) # 1,592

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
      filter(Q42_clean=="Hospital"|Q42_clean=="Hospital,ER"|Q42_clean=="Hospital,Ambulatory"|Q42_clean=="Hospital,Home"|Q42_clean=="Hospital,Other (non-work associated)"|Q42_clean=="Hospital,Other (work associated)" )  %>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)



# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs
  
age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs

#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()



## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts in hospital (n=1,524)")

```



```{r facet_n_contact_home_contact, dpi=1000, echo=FALSE}
## 1) Colleague contact and participants 
n_cont <- contact %>%
    filter(Q42_clean=="Home"|Q42_clean=="Hospital,Home"|Q42_clean=="Ambulatory,Home" ) 
# dim(n_cont) # 1,592

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
      filter(Q42_clean=="Home"|Q42_clean=="Hospital,Home"|Q42_clean=="Ambulatory,Home" )   %>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs
  
age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()

## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts at home (n=200)")
#gtable_show_layout(g)  , https://stackoverflow.com/questions/37984000/how-to-manage-the-t-b-l-r-coordinates-of-gtable-to-plot-the-secondary-y-axi
```



```{r facet_n_contact_other_work_contact,dpi=1000, echo=FALSE}
## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q42_clean=="Other (work associated)"| Q42_clean=="Hospital,Other (work associated)") # any Other contact


age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q42_clean=="Other (work associated)"| Q42_clean=="Hospital,Other (work associated)")%>% # any Other contact  %>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()

## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts, Other work associated (n=222)")

```



There are also a small number of other non-work associated (45 contacts), not included in the above chart

```{r facet_n_contact_HCW_contact, dpi=1000, echo=FALSE}
# create sinmme facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Colleague")
# dim(n_cont) # 1,592

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q38=="Colleague")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()
# 

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()
## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "C")


```

F: Average contacts per HCW with patients per day (n=570)
```{r facet_n_contact_patient_contact, dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Patient")

age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q38=="Patient")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()

## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "F")


```



```{r facet_n_household_contact , dpi=1000}
 


# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Household member")

age_cont <- as.data.frame(table(n_cont$Q40_level))
# dim(n_cont) # 1,592

age_cat <- contact %>% #create vector of N HCWS in each age group 
    filter(Q38=="Household member")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()

## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts per HCW with household contacts per day (n=143)")
# create single facet graphic of n contacts 


```




```{r facet_n_other_contact , dpi=1000}

# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
 filter(Q38=="Friend/acquaintance"|Q38=="Relative"|Q38=="Do not know this person personally, not a patient")
# dim(n_cont) # 1,592
age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
   filter(Q38=="Friend/acquaintance"|Q38=="Relative"|Q38=="Do not know this person personally, not a patient")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()
gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average contacts per HCW with other contacts per day (n=245)")
# create single facet graphic of n contacts 


```

Other contacts include Friend/acquaintance, relatives and unknown person (not a patient) 



## contacts by contact relationship 
e.g. by coworker, patient etc.  v.  contact type (direct proximity, non-physical, physical)

```{r facet_n_colleague_direct_contact , dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
   filter(Q38=="Colleague")%>%
  filter(Q41=="Direct proximity")
# dim(n_cont) # 1,592


age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
    filter(Q38=="Colleague")%>%
  filter(Q41=="Direct proximity")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs
  

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()



## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average direct proximity with colleagues (n=215)")
# create single facet graphic of n contacts 
```

```{r facet_n_colleague_non_phys_contact , dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Colleague")%>%
  filter(Q41=="Non-physical contact")
# dim(n_cont) # 1,592


age_cont <- as.data.frame(table(n_cont$Q40_level))

age_cat <- contact %>% #create vector of N HCWS in each age group 
  filter(Q38=="Colleague")%>%
  filter(Q41=="Non-physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average non-physical contact with colleagues (n=1,319)")
# create single facet graphic of n contacts 

```



```{r facet_n_colleague_phys_contact, dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Colleague")%>%
  filter(Q41=="Physical contact")


age_cont <- as.data.frame(table(n_cont$Q40_level))
# dim(n_cont) # 1,592

age_cat <- contact %>% #create vector of N HCWS in each age group 
   filter(Q38=="Colleague")%>%
  filter(Q41=="Physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average physical contact with colleagues (n=58)")
# create single facet graphic of n contacts 
```



```{r facet_n_patient_phys_contact , dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Patient")%>%
  filter(Q41=="Physical contact")


age_cont <- as.data.frame(table(n_cont$Q40_level))

# dim(n_cont) # 1,592

age_cat <- contact %>% #create vector of N HCWS in each age group 
   filter(Q38=="Patient")%>%
  filter(Q41=="Physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs


age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 
# 
# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average physical contact with patients (n=281)")
# create single facet graphic of n contacts 
```




```{r facet_n_patient_non_phys_contact , dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Patient")%>%
  filter(Q41=="Non-physical contact")


age_cont <- as.data.frame(table(n_cont$Q40_level))

# dim(n_cont) # 1,592

age_cat <- contact %>% #create vector of N HCWS in each age group 
   filter(Q38=="Patient")%>%
  filter(Q41=="Non-physical contact")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 

# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()


gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average non-physical contact with patients (n=1,754)")
# create single facet graphic of n contacts 
```

```{r facet_n_patient_direct_p_contact , dpi=1000}
# create single facet graphic of n contacts 

## 1) Colleague contact and participants 
n_cont <- contact %>%
  filter(Q38=="Patient")%>%
  filter(Q41=="Direct proximity")

age_cont <- as.data.frame(table(n_cont$Q40_level))

# dim(n_cont) # 1,592

age_cat <- contact %>% #create vector of N HCWS in each age group 
   filter(Q38=="Patient")%>%
  filter(Q41=="Direct proximity")%>%
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(age_cat)%>%
   table()

n_cont <- table(HCW = n_cont$age_cat,contact = n_cont$Q40_level)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont,1,age_cat*2, "/"))# row wise axis =1, column wise axis =2, age_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

age_cat <- as.data.frame(age_cat) # make data frame of age of HCWs
  
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker age",
    y = "Contact age",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal"
        )
 
# 
# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(age_cat,aes(x=age_cat, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+
  theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
  theme_classic()


gg_cols <-
  ggplot(age_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+
  theme(plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()+
  theme_classic()


## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))



## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                     t = 1, l=1, b=1, r=7) 

##  put legend topright
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average direct proximity physical contact with patients (n=328)")
# create single facet graphic of n contacts 

```


## Type of contact by job
```{r facet_job_contact_type , dpi=1000}

# create contact by job and contact type (physical, non-physical, direct proximity)

#add job to contact
contact_job<- left_join(contact,job_df, by = "HCWID") # add job
contact_job<-contact_job %>%
  mutate(Job_sum=case_when(Job_sum=="Diagnostic Imaging Technologist"~"Radiology Tech.",
                           Job_sum=="Administrative staff"~"Admin",   
                           Job_sum=="Midlevel Provider"~"Midlevel Provder",  
                           Job_sum=="Rehabilitation/transport"~"Rehab/transport",  
                           TRUE ~Job_sum ))%>% # simplify job names for later 
    mutate(Q41=case_when(Q41=="Physical contact"~"Physical",
                         Q41=="Non-physical contact"~"Non-\nphysical",
                         Q41=="Direct proximity"~"Direct \nproximity",
                           TRUE ~Q41 ))
# 
#  months_short %>%
#   mutate(Q19= case_when(Q19=="Less than 5 patients"~"Less than 5", TRUE ~Q19 ))

#table(contact$Job_sum) #join ok, no NAs

## 1) 
n_cont <- contact_job  #vetor of total N of contacts

type_cont <- as.data.frame(table(n_cont$Q41)) #create vector of N contacts by contact type
# dim(n_cont) # 1,592

job_cat <- contact_job %>% #create vector of N HCWS in each job group 
   distinct(HCWID, .keep_all = TRUE) %>% # keep other columns other then unique HCW ID
   dplyr::select(Job_sum)%>%
   table()

n_cont_1 <- table(HCW = n_cont$Job_sum,contact = n_cont$Q41)

# divide n contacts by n HCWs in that age group
div_cont <- as.data.frame(sweep(n_cont_1,1,job_cat*2, "/"))# row wise axis =1, column wise axis =2, job_cat by 2 so n_cont also divided by 2, since over 2 days
#keep NAs

job_cat <- as.data.frame(job_cat) # make data frame of age of HCWs
  
#n_prop <- as.data.frame((table(HCW = n_prop$age_cat,contact = n_prop$Q40_level))/(length(unique(n_prop$HCWID))*2)) # divide by number of HCWs and by 2 sinc data collected over 2 days 

# #make a plot for the legend
# p0 <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
#   geom_tile()+
#   geom_text(aes(label=round(Freq,2)))+
#   scale_fill_viridis_c(limits=c(0, 3.5), breaks=seq(0,3.5,by=1)) +#make scale the same across grid
#   labs( x = "Health care worker age",
#     y = "Contact age",
#     title = "A",
#     subtitle = "n=1,592",
#     fill = "Average contacts \nper HCW per day"     # legend title
#   )+
#   theme(legend.position="bottom")


 
## To format heatmap y.ticks with appropriate width (5 chars),
## to align with gg_rows y.tics
ytickform <- function(x){
    lab <- sprintf("%05s",x)
}

gg_hm <- ggplot(div_cont, aes(x = HCW, y = contact, fill=Freq))+
  geom_tile()+
  geom_text(aes(label=round(Freq,2)), size =3)+
  scale_fill_distiller(palette = "Blues",trans = 'reverse') +
  labs( x = "Health care worker job",
    y = "Contact type",
    fill = ""     # legend title
  )+
    theme(
        #axis.title = element_text(size=20),
        #text = element_text(size=15)
      legend.direction = "horizontal",
      axis.text.x = element_text(angle = 25,vjust = 1, hjust=1),
      axis.text=element_text(size=8)
        )
 

gg_hm
# 
# gg_rows <-ggplot(div_cont,aes(x=HCW, y=Freq))+
#   geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
#   labs(y="N", x="")+
#   theme(axis.title.x=element_blank(),plot.margin = unit(c(3,3,3,3), "mm"))+
#   theme_classic()
# #might need to add NAs here 
# 
# gg_cols <-
#   ggplot(div_cont, aes(x=contact, y=round(Freq,digits=2)))+
#   geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
#   labs (y="N",x="")+
#   theme(plot.margin = unit(c(3,3,3,3), "mm"))+
#   coord_flip()+
#   theme_classic()

gg_rows <-ggplot(job_cat,aes(x=Job_sum, y=Freq))+
  geom_bar(stat='identity',position= "stack", color="dark grey", fill="white") +
  labs(y="N", x="")+ 
  theme_classic()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        plot.margin = unit(c(3,3,3,3), "mm"))



gg_cols <-
  ggplot(type_cont, aes(x=Var1, y=round(Freq)))+
  geom_bar(stat='identity',position= "stack",color="dark grey", fill="white") +
  labs (y="N",x="")+  
  theme_classic()+
  theme(axis.text=element_text(size=8),
        axis.text.x = element_text(angle = 25,vjust = 1, hjust=1),
    plot.margin = unit(c(3,3,3,3), "mm"))+
  coord_flip()



## extract legend from heatmap
g <- ggplotGrob(gg_hm)$grobs
legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]

## plot heatmap without legend
g <- ggplotGrob(gg_hm + theme(legend.position="none"))

## add column and put column barplot within
g <- gtable_add_cols(g, unit(5,"cm"))
g <- gtable_add_grob(g, ggplotGrob(gg_cols), 
                     t = 1, l=ncol(g), b=nrow(g), r=ncol(g))

## add row on top and put row barplot within
g <- gtable_add_rows(g, unit(2.5,"cm"), 0)
g <- gtable_add_grob(g, ggplotGrob(gg_rows),
                   t = 1, l=3, b=1, r=9) 

##  put legend top right
g <- gtable_add_grob(g, legend,
                     t = 1, l=ncol(g), b=1, r=ncol(g)-1)


grid.newpage()
grid.arrange(g, top= "Average N contacts per day per job and contact type (n=2,550)")
# create single facet graphic of n contacts 
```



```{r}
#Create dataset for logistic regression 
regression_contact <-contact_June_22 %>%
  dplyr::select(HCWID,in_out,sum_hours_2day,sum_loc_2day)#data set of desired variables from contact_June_22

```



**coding note**  If floor mix of in and outpatient, then chosen as inpatient, if primarily outpatient (E.g. chemo infusion) the chose as outpatient


## To Do
[ ] create ReadMe files
[ ] remove extra variables you don't need from CSVs